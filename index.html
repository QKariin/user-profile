<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Task Dom üñ§ Slave UI</title>

  <!-- Your new clean link -->
  <link rel="stylesheet" href="style.css">

  <!-- Make sure this font link is still here too! -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;600;700&family=Rubik+Glitch&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body>

<!-- SOUND -->
<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green);">TASK<br>SUBMITTED</div>
    </div>
</div>

<svg style="display:none;">
    <symbol id="icon-coin" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.69 1.64 1.83 1.64 1.22 0 1.6-.64 1.6-1.26 0-.81-.42-1.22-2.34-1.67-2.37-.59-3.54-1.7-3.54-3.41 0-1.68 1.29-2.94 3.28-3.29V4h2.66v1.93c1.61.27 2.87 1.28 3.01 3.05h-1.95c-.14-.99-.68-1.55-1.7-1.55-1.04 0-1.55.56-1.55 1.15 0 .75.46 1.2 2.37 1.65 2.51.6 3.58 1.74 3.58 3.52 0 1.82-1.46 3.09-3.28 3.34z"/></symbol>
    <symbol id="icon-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></symbol>
    <symbol id="icon-send" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 13.41 12z"/></symbol>
    <symbol id="icon-timer" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></symbol>
</svg>

<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">

<div class="app-container">
    
    <!-- TOP SECTION -->
    <div class="top-section-split">
        <!-- LEFT: PROFILE & NAV -->
        <div class="layout-left">
            <div class="glass-card profile-card">
                <div class="pc-avatar-section">
                    <div class="pc-avatar-box" onclick="document.getElementById('profileUploadInput').click()">
                        <img id="profilePic" src="" class="pc-avatar-img">
                        <div class="pc-avatar-edit-overlay"><span style="font-size:1.5rem; color:white;">‚úé</span></div>
                    </div>
                    <div class="pc-info-wrapper">
                        <div id="subName" class="pc-name">SLAVE</div>
                        <div id="subHierarchy" class="pc-rank">LOADING...</div>
                        <div class="level-progress-container">
                            <div class="lp-labels">
                                <span>NEXT: <span id="nextLevelName" style="color:white;">-</span></span>
                                <span id="pointsNeeded">0 to go</span>
                            </div>
                            <div class="lp-bar-bg"><div id="progressBar" class="lp-bar-fill"></div></div>
                        </div>
                        
                        <!-- --- NEW DEVOTION SECTION --- -->
                        <div class="devotion-wrapper">
                          <!-- THE HYBRID BUTTON -->
                          <div id="btn" class="kneel-btn-bar" onclick="handleClick()" style="position: relative; display: block;">
                              <!-- ANIMATION LAYER (The Fill) -->
                              <span id="fill" class="bar-fill" style="display: block; position: absolute; top: 0; left: 0; height: 100%; z-index: 1;"></span> 

                              <!-- TEXT LAYER (The Labels) -->
                              <div class="bar-text" style="position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; pointer-events: none;">
                                  <span id="txt-main" style="font-size: 0.85rem; font-weight: 900; color: grey;">KNEEL</span>
                                  <span id="txt-sub" style="font-size: 0.45rem; color: #888; font-family: 'Rajdhani';">TODAY KNEELING: 0</span>
                              </div>
                          </div>

                          <!-- DAILY ID -->
                          <div class="daily-id-display">
                              DAILY ID: <span id="dailyRandomId" class="did-val">#----</span>
                          </div>
                      </div>
                   </div>
                </div>
                <!-- STATS GRID UPDATED WITH ICONS/LABELS -->
                <div class="pc-stats-grid">
                    <div class="stat-single-row row-score" style="display: flex; align-items: baseline; justify-content: center; gap: 8px;">
                    <div id="points" class="ssr-val">0</div>
                    <div class="ssr-lbl">POINTS</div>
                </div>
                    <div class="stat-single-row row-coins" style="align-items: center; justify-content: center; gap: 8px;">
                        <div id="coins" class="ssr-val">0</div>
                        <svg style="width:20px; height:20px; fill:var(--neon-yellow); filter:drop-shadow(0 0 5px rgba(255, 215, 0, 0.6));">
                            <use href="#icon-coin"></use>
                        </svg>
                    </div>
                </div>
                <div class="stats-toggle-btn" onclick="toggleStats()">STATS ‚ñæ</div>
                <!-- STATS DROPDOWN UPDATED WITH SLAVE SINCE -->
                <div id="statsContent">
                  <div class="stat-row-group">
                      <div class="stat-header" style="text-align: center;">SLAVE'S ACTIVITY</div>
                      <div class="stat-line"><span>Task Streak</span> <strong id="statStreak">0</strong></div>
                      <div class="stat-line"><span>Total Tasks</span> <strong id="statTotal">0</strong></div>
                      <div class="stat-line"><span>Completed</span> <strong id="statCompleted">0</strong></div>
                      <div class="stat-line"><span>Skipped</span> <strong id="statSkipped">0</strong></div>
                      <div class="stat-line"><span>Total Kneeling</span> <strong id="statTotalKneels">0</strong></div>

                      <!-- Centered Slave Since Section -->
                      <div style="text-align: center; border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; display: flex; flex-direction: column; align-items: center;">
                          <div class="stat-header" style="border:none; margin:0; padding:0; font-size: 0.65rem;">SLAVE SINCE</div>
                          <strong id="slaveSinceDate" style="font-size: 0.85rem; color: white; display: block; margin-top: 2px;">--/--/--</strong>
                      </div>
                  </div>
              </div>
            </div>

            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('serve')">HOME</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('news')">QKARIN</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('tribute')">TRIBUTE</button>
                <button id="nav-btn-session" class="tab-btn nav-togglable" onclick="switchTab('session')">BUY SESSION</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('rewards')">REWARDS</button>
                <button class="tab-btn nav-togglable" onclick="switchTab('protocol')">PROTOCOL</button>
                <button class="tab-btn btn-foot-bank nav-togglable" onclick="switchTab('buy')">BUY COINS</button>
            </div>
        </div>

        <!-- RIGHT: DYNAMIC CONTENT -->
        <div class="layout-right">
            
            <!-- VIEW 1: HOME (TASKS & CHAT) -->
            <div id="viewServingTop" style="display:flex; flex-direction:column; gap:15px;">
                <!-- Task Card -->
                <div id="taskCard" class="glass-card">
                    <div id="activeBadge">ACTIVE TASK</div>
                    <div id="taskContent" style="width: 100%; padding: 10px 0; text-align: center; flex-grow: 1; display:flex; flex-direction:column; justify-content:center;">
                        <h2 id="readyText" style="font-weight:bold; margin-bottom:5px; color:white; font-size:1.5rem;">Ready?</h2>
                        <p class="rajdhani" style="color:#aaa; margin:0;">Waiting for orders.</p>
                    </div>
                    <div id="cooldownSection" class="hidden" style="width: 100%; display:flex; flex-direction:column; align-items:center; text-align:center; padding-bottom: 10px;">
                        <div id="timerDisplay" style="font-size:2rem; font-weight:bold; margin:5px 0; color:white; text-shadow: 0 0 10px rgba(255,255,255,0.3);">24:00:00</div>
                        <input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="handleEvidenceUpload(this)">
                        <button onclick="document.getElementById('evidenceInput').click()" class="action-btn btn-upload">UPLOAD PROOF</button>
                        <button onclick="cancelPendingTask()" id="btnSkip" style="background:transparent; border:none; color:#ddd; margin-top:10px; font-size:0.7rem; cursor:pointer; text-transform:uppercase;">Skip / Cancel</button>
                        <div id="uploadStatus" style="height:15px; font-size:0.7rem; color:#888; margin-top:5px;"></div>
                    </div>
                    <div id="mainButtonsArea" style="width:100%; margin-top:auto;">
                        <button id="newTaskBtn" onclick="getRandomTask()" class="action-btn" style="width: 50%; margin: 0 auto; display: block;">REQUEST TASK</button>
                    </div>
                </div>

                <!-- Chat Card -->
                <div id="chatCard" class="glass-card">
                    <div id="chatBadge">CHAT</div>
                    <div id="sessionOverlay">
                        <div onclick="closeSessionUI()" style="position:absolute; top:15px; right:15px; color:var(--neon-green); font-size:1.5rem; font-weight:bold; cursor:pointer; line-height:1; z-index:100;">√ó</div>
                        <div style="padding: 20px; color: white; width: 100%; max-width: 400px; text-align: center;">
                            <h2 style="font-family:'Rubik Glitch'; font-size: 2rem; color: var(--neon-pink); margin-bottom: 20px;">REQUEST SESSION</h2>
                            <div style="margin-bottom: 20px; text-align: left;">
                                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#ccc; font-size: 0.7rem; letter-spacing: 1px;">SESSION TYPE</label>
                                <div class="session-opt-group">
                                    <label class="session-radio-label">
                                        <input type="radio" name="sessionType" value="chat" data-cost="3000" class="session-radio-input" onchange="updateSessionCost()" checked>
                                        <span class="s-lbl-title">CHAT</span><span class="s-lbl-cost">3000 ü™ô</span>
                                    </label>
                                    <label class="session-radio-label">
                                        <input type="radio" name="sessionType" value="video" data-cost="5000" class="session-radio-input" onchange="updateSessionCost()">
                                        <span class="s-lbl-title">VIDEO</span><span class="s-lbl-cost">5000 ü™ô</span>
                                    </label>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; text-align: left;">
                                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#ccc; font-size: 0.7rem; letter-spacing: 1px;">FOCUS / KINK</label>
                                <select id="sessionFocus" style="width:100%; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:8px; font-family:'Rajdhani'; outline:none;">
                                    <option value="JEI">JEI</option><option value="CEI">CEI</option><option value="SPH">SPH</option><option value="HUMILIATION">HUMILIATION</option><option value="EXPOSING">EXPOSING</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 20px; text-align: left;">
                                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#ccc; font-size: 0.7rem; letter-spacing: 1px;">TIME (TODAY)</label>
                                <select id="sessionTimeSelect" style="width:100%; background:#111; border:1px solid #444; color:white; padding:10px; border-radius:8px; font-family:'Rajdhani'; outline:none;">
                                    <option value="NOW">Now (Within 10m)</option><option value="30MIN">In 30 Minutes</option><option value="1HOUR">In 1 Hour</option><option value="3HOURS">In 3 Hours</option><option value="6HOURS">In 6 Hours</option><option value="LATER">Later Today (Discuss in Chat)</option>
                                </select>
                            </div>
                            <div style="margin-top: 30px;">
                                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">HOLD AMOUNT: <span id="sessionCostDisplay" style="color:var(--neon-yellow); font-weight:bold;">3000</span> ü™ô</div>
                                <div style="display:flex; gap: 10px;">
                                    <button onclick="submitSessionRequest()" class="action-btn" style="background:var(--neon-pink); border:none; width:100%;">CONFIRM REQUEST</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="specialGlassOverlay" onclick="breakGlass(event)" ontouchstart="breakGlass(event)">
                        <img src="https://static.wixstatic.com/media/ce3e5b_b75c0e95797b4ba8abe4198a83b6c9ae~mv2.gif" class="broken-glass-img" alt="Break Glass">
                    </div>
                    <div class="chat-header-row">
                        <div class="chat-avatar-container">
                            <div id="chatStatusRing" class="dom-status-ring ring-inactive"></div>
                            <img src="https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png" class="chat-header-img">
                        </div>
                        <div class="chat-header-info">
                            <div class="chat-header-title">QUEEN KARIN</div>
                            <div id="chatStatusBadge" class="chat-status-text">LAST SEEN: TODAY</div>
                        </div>
                        <button id="chatSessionBtn" onclick="openSessionUI()"><span>üìÖ</span> REQUEST SESSION</button>
                    </div>
                    <div class="chat-area" id="chatBox">
                        <button id="chatLoadMoreBtn" onclick="loadMoreChat()" style="display:none; width: 100%; background: transparent; color: #666; font-size: 0.7rem; border: none; padding: 5px; cursor: pointer; text-transform: uppercase; margin-bottom: 10px;">‚ñ≤ Load Older Messages</button>
                        <div id="chatContent"></div>
                    </div>
                    <div class="coin-presets-row">
                        <button class="coin-btn" onclick="sendCoins(500)">500 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        <button class="coin-btn" onclick="sendCoins(1000)">1000 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        <button class="coin-btn" onclick="sendCoins(2000)">2000 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        <button class="coin-btn" onclick="sendCoins(5000)">5000 <svg style="width:12px;height:12px;"><use href="#icon-coin"></use></svg></button>
                        </div>
                    <div class="chat-input-row">
                        <div id="plusMenu" class="d-none">
                            <label class="menu-btn" for="adminMediaInput">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                                Photo/Video
                            </label>
                        </div>
                        <input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden-input" onchange="handleAdminUpload(this)">
                        <button class="btn-plus" onclick="document.getElementById('adminMediaInput').click()">+</button>
                        <input type="text" id="chatMsgInput" class="chat-input" placeholder="Message..." onkeypress="handleChatKey(event)">
                        <button class="chat-send" onclick="sendChatMessage()"><svg style="width:20px; height:20px; fill:black;"><use href="#icon-send"></use></svg></button>
                    </div>
                
                    <!-- CHAT MEDIA OVERLAY (Mobile Friendly) -->
                    <div id="chatMediaOverlay" onclick="closeChatPreview()" style="display:none; position:absolute; top:60px; bottom:70px; left:0; right:0; background:rgba(0,0,0,0.95); z-index:80; backdrop-filter:blur(5px); flex-direction:column; align-items:center; justify-content:center;">
                        
                        <!-- CLOSE BUTTON -->
                        <div style="position:absolute; top:10px; right:10px; color:white; font-size:2rem; font-weight:bold; cursor:pointer; z-index:90; padding:10px;">√ó</div>
                        
                        <div id="cmoContent" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                            <!-- Media loads here -->
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW 7: QKARIN (NEW SOCIAL PROFILE) -->
            <div id="viewNews" class="hidden">
                <div class="glass-card" style="height: 100%; padding:0; overflow:hidden; background:#000;">
                    
                    <div class="social-header">
                        <div class="sh-avatar-frame">
                            <img src="https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png" class="sh-avatar">
                        </div>
                        <div class="sh-info">
                            <div class="sh-name">QUEEN KARIN</div>
                            <div class="sh-bio">Time to serve.</div>
                            <div class="sh-stats">
                                <div class="sh-stat-item"><span class="sh-val" id="cntPosts">0</span><span class="sh-lbl">POSTS</span></div>
                                <div class="sh-stat-item"><span class="sh-val">‚àû</span><span class="sh-lbl">OWNER</span></div>
                                <div id="domStatusBadge" class="sh-stat-item"><span class="sh-val" style="color:var(--neon-green)">ONLINE</span><span class="sh-lbl">STATUS</span></div>
                            </div>
                        </div>
                    </div>

                    <div id="domVideoReel" class="highlights-rail"></div>

                    <div class="feed-nav"><div class="fn-btn active">GRID</div></div>

                    <div id="newsGrid" class="social-grid"></div>

                    <div id="streamContainer" class="video-container hidden" style="margin-top:20px;">
                        <iframe id="twitchFrame" class="twitch-iframe" src="" allowfullscreen></iframe>
                        <div id="streamLockOverlay" class="glass-lock-overlay">...</div>
                    </div>

                </div>
            </div>

            <!-- OTHER VIEWS (Tribute, Session, Rewards, Hierarchy, Buy) -->
            <div id="viewTribute" class="hidden">
                <div class="glass-card">
                    <h2 style="text-align:center; color:white; font-family:'Rubik Glitch', sans-serif; font-size:2rem; margin-bottom:15px; text-shadow:0 0 10px rgba(255,255,255,0.3);">THE STORE</h2>
                    <div class="cat-scroll">
                        <div class="cat-pill active" onclick="filterStore('all', this)">ALL</div>
                        <div class="cat-pill" onclick="filterStore('little', this)">LITTLE</div>
                        <div class="cat-pill" onclick="filterStore('middle', this)">MIDDLE</div>
                        <div class="cat-pill" onclick="filterStore('big', this)">BIG</div>
                        <div class="cat-pill" onclick="filterStore('naughty', this)">NAUGHTY</div>
                        <div class="cat-pill" onclick="filterStore('freedom', this)">FREEDOM</div>
                    </div>
                    <div id="storeGrid" class="store-grid"></div>
                </div>
            </div>
            
            <div id="viewSession" class="hidden">
                <div class="glass-card" style="text-align:center; padding: 50px;">
                    <h2 style="font-size:2rem; color:var(--neon-pink); text-shadow:0 0 10px var(--neon-pink);">PRIVATE SESSIONS</h2>
                    <p style="color:#aaa; font-family:'Rajdhani'; margin-top:10px;">Currently offline. Check back later.</p>
                    <button class="action-btn" style="margin-top:20px; opacity:0.5; cursor:not-allowed;">CHECK AVAILABILITY</button>
                </div>
            </div>
            
            <div id="viewProtocol" class="hidden">
                <div class="glass-card">
                    <h2 style="text-align:center; color:white; font-family:'Orbitron'; font-size:1.8rem; margin-bottom:20px; letter-spacing:2px;">OPERATIONAL PROTOCOL</h2>

                    <div style="display:grid; grid-template-columns: 1fr; gap:10px;">

                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid var(--neon-yellow);">
                            <h3 class="protocol-header" style="color:var(--neon-yellow);">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <svg style="width:18px; height:18px; fill:var(--neon-yellow);"><use href="#icon-coin"></use></svg> 
                                    THE ECONOMY
                                </div>
                                <span class="protocol-arrow">‚ñº</span>
                            </h3>
                            <div class="protocol-content">
                                <p style="margin-bottom:10px;"><strong style="color:white;">COINS (Currency):</strong> Your physical worth. Used to buy gifts from the <strong>Wishlist</strong>, pay mandatory tributes, or purchase your freedom from a task via the <strong>Skip</strong> function.</p>
                                <p><strong style="color:white;">POINTS (Status):</strong> Your spiritual worth. Earned strictly through <strong>Kneeling</strong> and completing <strong>Duties</strong>. Points determine your rank in the <strong>Hierarchy</strong>.</p>
                            </div>
                        </div>

                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid var(--neon-green);">
                            <h3 class="protocol-header" style="color:var(--neon-green);">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <svg style="width:18px; height:18px; fill:var(--neon-green);"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg> 
                                    DUTY & TASKS
                                </div>
                                <span class="protocol-arrow">‚ñº</span>
                            </h3>
                            <div class="protocol-content">
                                <p style="margin-bottom:10px;">Click <strong>"REQUEST TASK"</strong> to receive your orders.</p>
                                <ul style="list-style: none; padding-left: 0; color: #ccc;">
                                    <li style="margin-bottom:5px;"><strong style="color:white;">- 24h Deadline:</strong> Proof must be uploaded within 24 hours.</li>
                                    <li><strong style="color:white;">- Failure:</strong> A <strong>300 COIN FINE</strong> is applied automatically if the timer expires.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid var(--neon-pink);">
                            <h3 class="protocol-header" style="color:var(--neon-pink);">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <svg style="width:18px; height:18px; fill:var(--neon-pink);"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg> 
                                    DEVOTION
                                </div>
                                <span class="protocol-arrow">‚ñº</span>
                            </h3>
                            <div class="protocol-content">
                                <p>Kneel once every <strong>60 minutes</strong> via the profile bar. Consistency prevents rank degradation.</p>
                            </div>
                        </div>

                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid #fff;">
                            <h3 class="protocol-header" style="color:#fff;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <svg style="width:18px; height:18px; fill:#fff;"><path d="M12 2l2.4 4.9 5.4.8-3.9 3.8.9 5.4-4.8-2.5-4.8 2.5.9-5.4-3.9-3.8 5.4-.8z"/></svg> 
                                    ROYAL HIERARCHY
                                </div>
                                <span class="protocol-arrow">‚ñº</span>
                            </h3>
                            <div class="protocol-content">
                                <p style="margin-bottom:15px; font-size:0.8rem; color:#aaa;">Ranks are earned through total Points. Higher ranks unlock private session slots.</p>
                                <div id="hierarchyGrid" class="grid gap-4"></div>
                            </div>
                        </div>

                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid #ff003c;">
                            <h3 class="protocol-header" style="color:#ff003c;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <svg style="width:18px; height:18px; fill:#ff003c;"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg> 
                                    COMMANDS
                                </div>
                                <span class="protocol-arrow">‚ñº</span>
                            </h3>
                            <div class="protocol-content">
                                <p><strong style="color:white;">Glass Break:</strong> Click the broken glass overlay immediately to read urgent commands.</p>
                            </div>
                        </div>

                        <div class="protocol-item" onclick="toggleSection(this)" style="border:1px solid #666;">
                            <h3 class="protocol-header" style="color:#ccc;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <svg style="width:18px; height:18px; fill:#ccc;"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg> 
                                    LAWS & REGULATIONS
                                </div>
                                <span class="protocol-arrow">‚ñº</span>
                            </h3>
                            <div class="protocol-content">
                                <ul style="list-style: none; padding: 0; margin: 0; color: #ccc;">
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 1:</strong> <span id="r1">Loading...</span></li>
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 2:</strong> <span id="r2">Loading...</span></li>
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 3:</strong> <span id="r3">Loading...</span></li>
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 4:</strong> <span id="r4">Loading...</span></li>
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 5:</strong> <span id="r5">Loading...</span></li>
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 6:</strong> <span id="r6">Loading...</span></li>
                                    <li style="margin-bottom: 8px;"><strong style="color:white;">Section 7:</strong> <span id="r7">Loading...</span></li>
                                    <li style="margin-bottom: 0px;"><strong style="color:white;">Section 8:</strong> <span id="r8">Loading...</span></li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div id="viewRewards" class="hidden">
                <div class="glass-card" style="text-align:center; padding: 50px;">
                    <h2 style="font-size:2rem; color:var(--neon-yellow); text-shadow:0 0 10px var(--neon-yellow);">REWARDS</h2>
                    <p style="color:#aaa; font-family:'Rajdhani'; margin-top:10px;">Unlock perks as you level up.</p>
                    <div style="margin-top:20px; font-size: 3rem;">üéÅ</div>
                </div>
            </div>

            <div id="viewHierarchy" class="hidden">
                <div class="glass-card">
                    <div class="text-center mb-4"><h1 class="accent text-2xl md:text-4xl font-bold mb-1">ROYAL HIERARCHY</h1><p class="text-gray-400 text-xs">Slave devotion ranks</p></div>
                    <div class="grid gap-4" id="hierarchyGrid"></div>
                </div>
            </div>

            <div id="viewBuy" class="hidden">
                <div class="glass-card">
                    <h2 style="text-align:center; color:var(--neon-yellow); font-family:'Rubik Glitch', sans-serif; font-size:2rem; margin-bottom:5px; text-shadow:0 0 10px rgba(255,215,0,0.3);">BUY COINS</h2>
                    <p style="text-align:center; color:#888; font-family:'Rajdhani'; font-size:0.8rem; margin-bottom:15px;">Purchase coins to pay tribute.</p>
                    <div class="store-grid">
                        <div class="store-item" style="border-color: var(--neon-yellow);"><div class="si-img-box"><svg style="width:40px; height:40px; fill:var(--neon-yellow);"><use href="#icon-coin"></use></svg></div><div class="si-info"><div class="si-name" style="color:white;">100 COINS</div><button class="si-btn" style="background:rgba(255,215,0,0.1); border-color:var(--neon-yellow); color:var(--neon-yellow);" onclick="buyRealCoins(100)">‚Ç¨10.00</button></div></div>
                        <div class="store-item" style="border-color: var(--neon-yellow);"><div class="si-img-box"><svg style="width:50px; height:50px; fill:var(--neon-yellow);"><use href="#icon-coin"></use></svg></div><div class="si-info"><div class="si-name" style="color:white;">500 COINS</div><button class="si-btn" style="background:rgba(255,215,0,0.1); border-color:var(--neon-yellow); color:var(--neon-yellow);" onclick="buyRealCoins(500)">‚Ç¨50.00</button></div></div>
                        <div class="store-item" style="border-color: var(--neon-yellow); box-shadow: 0 0 10px rgba(255,215,0,0.2);"><div class="si-img-box"><div style="position:absolute; font-size:2rem;">üí∞</div></div><div class="si-info"><div class="si-name" style="color:white;">1000 COINS</div><button class="si-btn" style="background:var(--neon-yellow); border-color:var(--neon-yellow); color:black; font-weight:bold;" onclick="buyRealCoins(1000)">‚Ç¨100.00</button></div></div>
                        <div class="store-item" style="border-color: var(--neon-yellow);"><div class="si-img-box"><div style="position:absolute; font-size:2rem;">üíé</div></div><div class="si-info"><div class="si-name" style="color:white;">2500 COINS</div><button class="si-btn" style="background:rgba(255,215,0,0.1); border-color:var(--neon-yellow); color:var(--neon-yellow);" onclick="buyRealCoins(2500)">‚Ç¨250.00</button></div></div>
                        <div class="store-item" style="border-color: var(--neon-yellow);"><div class="si-img-box"><div style="position:absolute; font-size:2rem;">üëë</div></div><div class="si-info"><div class="si-name" style="color:white;">5000 COINS</div><button class="si-btn" style="background:rgba(255,215,0,0.1); border-color:var(--neon-yellow); color:var(--neon-yellow);" onclick="buyRealCoins(5000)">‚Ç¨500.00</button></div></div>
                        <div class="store-item" style="border-color: var(--neon-yellow);"><div class="si-img-box"><div style="position:absolute; font-size:2rem;">üè¶</div></div><div class="si-info"><div class="si-name" style="color:white;">10k COINS</div><button class="si-btn" style="background:rgba(255,215,0,0.1); border-color:var(--neon-yellow); color:var(--neon-yellow);" onclick="buyRealCoins(10000)">‚Ç¨1000.00</button></div></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

       
<!-- EVIDENCE LOG HEADER (Now clean and separate) -->
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; font-size:0.8rem; color:#fff; font-weight:bold; padding-left: 5px;">
            <div style="width:6px; height:6px; background:var(--neon-yellow); border-radius:50%;"></div> EVIDENCE LOG
        </div>

        <div id="pendingSection" style="display:none; width:100%;">
            <div class="section-header">PENDING REVIEW</div>
            <div id="pendingGrid" class="pending-grid"></div>
        </div>

        <!-- THE TRAP: Added position: relative here -->
        <div id="historySection" style="display:none; width:100%; position: relative; overflow: hidden; min-height: 450px;">
            <div class="section-header">HISTORY</div>

            <!-- MODAL IS NOW TRAPPED INSIDE HISTORY -->
            <div id="glassModal" class="glass-modal" onclick="closeModal(event)">
          <!-- THE MEDIA BACKGROUND (Sub Proof or Queen Media) -->
          <div id="modalMediaContainer" class="modal-bg-photo"></div>
      
          <!-- THE FROSTED GLASS REVIEW CARD -->
          <div id="reviewCard" class="review-details-card">
              <!-- Status Badge -->
              <div id="modalStatus" class="m-status-badge-big">APPROVED</div>
      
              <!-- Points & Sticker Row -->
              <div style="display:flex; align-items:center; gap:20px; margin-bottom:10px;">
                  <div id="modalPoints" class="m-points-val">+0 PTS</div>
                  <div id="modalSticker"></div>
              </div>
      
              <!-- Queen's Feedback Split Row -->
              <div id="feedbackRow" class="q-feedback-split">
                  <!-- Left: Queen's Media Thumb -->
                  <div class="q-thumb-box" onclick="toggleHistoryView('queen_media', event)">
                      <div id="modalFeedbackMedia" class="q-thumb-fill"></div>
                      <div class="q-zoom-hint">üîç</div>
                  </div>
                  
                  <!-- Right: Secondary Nav -->
                  <div class="q-nav-stack">
                      <div class="q-label">QUEEN'S FEEDBACK</div>
                      <button class="q-nav-btn" onclick="toggleHistoryView('comment', event)">SEE COMMENT</button>
                      <button class="q-nav-btn" onclick="toggleHistoryView('queen_media', event)">SEE PHOTO</button>
                  </div>
              </div>
      
              <!-- The Text Comment (Hidden by default) -->
              <div id="modalFeedbackText" class="q-comment-area hidden"></div>
          </div>
      
          <!-- Task text overlay -->
          <div id="modalOrderText" class="order-overlay-centered hidden"></div>
      
          <!-- Bottom Nav Buttons -->
          <div class="modal-footer-nav">
              <button onclick="toggleHistoryView('task', event)" class="view-btn">SEE TASK</button>
              <button onclick="toggleHistoryView('proof', event)" class="view-btn">SEE PROOF</button>
              <button onclick="toggleHistoryView('info', event)" class="view-btn">SEE STATUS</button>
              <button onclick="closeModal(null)" class="view-btn close-btn">CLOSE</button>
          </div>
      </div>
    </div> <!-- Closes app-container -->
</div> <!-- Closes layout-right or main wrapper depending on your exact nesting -->

<script>
    const CLOUD_NAME = 'dfqvezjlj'; 
    const ACCOUNT_ID = 'kW2K8hR';
    const API_KEY = 'public_kW2K8hR6YbQXStTvMf5ZDYbVf1fQ';
    const UPLOAD_PRESET = 'task_uploads'; 
    const QUEEN_AVATAR = "https://static.wixstatic.com/media/ce3e5b_1bd27ba758ce465fa89a36d70a68f355~mv2.png";
    const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/3233/3233508.png"; 
    const TWITCH_CHANNEL = "qkarin"; 
    const SESSION_VERSION = "v1";
    const STREAM_PASSWORDS = ["QUEEN", "OBEY", "SESSION"];
                
    let gameStats = { totalTasks: 0, completedTasks: 0, currentStreak: 0, points: 0, coins: 0 };
    let stats = { approvedTasks: 0, rejectedTasks: 0, skippedTasks: 0, dailyCompletedTasks: 0, dailyStreak: 0, dailyScore: 0, monthlyTotalTasks: 0, monthlyScore: 0};
    let userProfile = { name: "Slave", hierarchy: "Loading...", avatar: DEFAULT_AVATAR };
    let currentTask = null;
    let taskDatabase = []; 
    let galleryData = []; 
    let pendingTaskState = null; 
    let taskJustFinished = false;
    let cooldownInterval = null;
    let ignoreBackendUpdates = false; 
    let lastChatJson = ""; 
    let lastGalleryJson = ""; 
    let isInitialLoad = true;
    let chatLimit = 10;
    let lastNotifiedMessageId = null;
    let historyLimit = 12; 
    let pendingLimit = 4;  
    let currentView = 'serve'; 
    let resetUiTimer = null; 
    let taskQueue = []; 

    /* --- RESTORED DATA --- */
    const CMS_HIERARCHY = [
        { Title: "Hall Boy", Icon: "üßπ", Order: 1, Points: "0+", Description: "Entry level of service.", StatusText: "First line of service.", ProtocolText: "Perform basic tasks.", DutiesText: "Prove you live to serve.", ContactText: "15MIN DAILY SLOT", CssClass: "" },
        { Title: "Footman", Icon: "üö∂‚Äç‚ôÇÔ∏è", Order: 2, Points: "2000+", Description: "Learn to serve.", StatusText: "Time to earn your place.", ProtocolText: "Serve quickly and reliably.", DutiesText: "Perfect Timing.", ContactText: "30MIN DAILY SLOT", CssClass: "" },
        { Title: "Silverman", Icon: "üç¥", Order: 3, Points: "5000+", Description: "Dedicated submissive.", StatusText: "Skilled and polished sub.", ProtocolText: "Focus on improvement.", DutiesText: "Face all challenges.", ContactText: "30MIN DAILY SLOT", CssClass: "" },
        { Title: "Butler", Icon: "üç∑", Order: 4, Points: "10000+", Description: "Trusted submissive.", StatusText: "Mastered consistency.", ProtocolText: "Notice needs without being told.", DutiesText: "Devotion is foundation.", ContactText: "DAILY 2x30min SLOTS", CssClass: "" },
        { Title: "Chamberlain", Icon: "üè∞", Order: 5, Points: "20000+", Description: "Senior submissive.", StatusText: "Act with excellence.", ProtocolText: "Carry yourself with dignity.", DutiesText: "Uphold standards.", ContactText: "UNLIMITED", CssClass: "Secretary" },
        { Title: "Secretary", Icon: "üìú", Order: 6, Points: "50000+", Description: "Worthy of trust.", StatusText: "Inner Circle.", ProtocolText: "Respect and safeguard.", DutiesText: "Authority on smaller matters.", ContactText: "UNLIMITED", CssClass: "elite-butler" },
        { Title: "Queen's Champion", Icon: "‚öîÔ∏è", Order: 7, Points: "100000", Description: "Ultimate submissive!", StatusText: "You have made it!", ProtocolText: "2 bodies, 1 soul!", DutiesText: "Enjoy the love you earned.", ContactText: "LEGENDARY", CssClass: "legendary" }
    ];

    // --- NEW: Audio Unlocker for Browsers ---
    let audioUnlocked = false;
    document.addEventListener('click', () => {
        if (!audioUnlocked) {
            // Play and immediately pause all sounds to "wake them up"
            ['msgSound', 'coinSound', 'skipSound'].forEach(id => {
                const sound = document.getElementById(id);
                if (sound) {
                    sound.play().then(() => {
                        sound.pause();
                        sound.currentTime = 0;
                    }).catch(e => console.log("Audio waiting for interaction"));
                }
            });
            audioUnlocked = true;
            console.log("Audio Engine Unlocked");
        }
    }, { once: true });
  
    // Placeholder for CMS hierarchy data
    let cmsHierarchyData = null;

    // --- WISHLIST IS NOW EMPTY (LOADS FROM CMS) ---
    let WISHLIST_ITEMS = [];

    const LEVELS = [{name: "HallBoy", min: 0}, {name: "Footman", min: 2000}, {name: "Silverman", min: 5000}, {name: "Butler", min: 10000}, {name: "Chamberlain", min: 20000}, {name: "Secretary", min: 50000}, {name: "Queen's Champioin", min: 100000}];

    function getOptimizedUrl(url, width) {
        if (!url) return "";
        if (url.includes("cloudinary.com") && url.includes("/upload/")) {
            let cleanUrl = url.replace(/\.(mp4|webm|mov)$/i, ".jpg");
            return cleanUrl.replace("/upload/", `/upload/f_auto,q_auto,dpr_auto,c_limit,w_${width}/`);
        }
        if (url.includes("upcdn.io")) {
            let cleanUrl = url.replace(/\.(mp4|webm|mov)$/i, ".jpg");
            const sep = cleanUrl.includes("?") ? "&" : "?";
            return `${cleanUrl}${sep}width=${width}&format=auto&quality=auto&dpr=auto`;
        }
        return url;
    }

    const SafeStorage = {
        setItem: (key, value) => { try { localStorage.setItem(key, value); } catch(e) {} },
        getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
        removeItem: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
    };
    function triggerSound(id) {
        const el = document.getElementById(id);
        if (el) {
            el.pause(); // Reset any currently playing sound
            el.currentTime = 0;
            
            const playPromise = el.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Sound blocked. Sub needs to click the screen once.");
                });
            }
        }
    }

    /* --- INIT --- */
    if(!userProfile.avatar) { document.getElementById('profilePic').src = DEFAULT_AVATAR; }
    const resizeObserver = new ResizeObserver(() => { 
        if(window.parent) window.parent.postMessage({ iframeHeight: document.body.scrollHeight }, '*'); 
    });
    resizeObserver.observe(document.body);

    function initDomProfile() {
        const frame = document.getElementById('twitchFrame');
        if(frame && !frame.src) {
            const parents = ["qkarin.com", "www.qkarin.com", "html-components.wixusercontent.com", "filesusr.com", "editor.wix.com", "manage.wix.com", "localhost"];
            let parentString = "";
            parents.forEach(p => parentString += `&parent=${p}`);
            frame.src = `https://player.twitch.tv/?channel=${TWITCH_CHANNEL}${parentString}&muted=true&autoplay=true`;
        }
        const savedSession = SafeStorage.getItem('taskDomStreamSession');
        const savedExpiry = SafeStorage.getItem('taskDomStreamExpiry');
        if (savedSession === SESSION_VERSION && savedExpiry && parseInt(savedExpiry) > Date.now()) {
            document.getElementById('streamLockOverlay').classList.add('unlocked');
        } else {
            SafeStorage.removeItem('taskDomStreamSession');
            SafeStorage.removeItem('taskDomStreamExpiry');
            document.getElementById('streamLockOverlay').classList.remove('unlocked');
        }
    }
    initDomProfile();

       // 1. Check for Full Data (Database & Profile)
      if (data.type === "UPDATE_FULL_DATA") {
          if (data.profile) { 
              gameStats = { ...gameStats, ...data.profile }; 
              if (data.profile.lastWorship) lastWorshipTime = new Date(data.profile.lastWorship).getTime();
              updateStats(); 
          }
          if (data.galleryData) {
              galleryData = Array.isArray(data.galleryData) ? data.galleryData : JSON.parse(data.galleryData);
              renderGallery(); 
          }
      }
    
      // 2. Check for Chat Echo (Instant Messages)
      if (data.type === "CHAT_ECHO") {
          const chatContent = document.getElementById('chatContent');
          if (chatContent && data.msgObj) {
              const m = data.msgObj;
              const isMe = (m.sender === 'user'); 
              const msgClass = isMe ? 'm-slave' : 'm-queen';
              const rowClass = isMe ? 'mr-out' : 'mr-in';
              
              const contentHtml = `<div class="msg ${msgClass}">${m.message}</div>`;
              const timeDiv = `<div class="msg-time">${new Date(m._createdDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
              const rowContent = isMe ? 
                  `<div class="msg-col" style="justify-content: flex-end;">${contentHtml} ${timeDiv}</div>` :
                  `<div class="msg-col" style="justify-content: flex-start;">${contentHtml} ${timeDiv}</div>`;
              
              chatContent.innerHTML += `<div class="msg-row ${rowClass}">${rowContent}</div>`;
              forceBottom(); 
          }
      }
    
      
      // FIX: Capture all 8 Rules from CMS safely
      if (data.type === 'UPDATE_RULES') {
          const rules = data.payload || {};
          for (let i = 1; i <= 8; i++) {
              const el = document.getElementById('r' + i);
              if (el && rules['rule' + i]) el.innerHTML = rules['rule' + i];
          }
      }
    
      // CMS TASKS
      if (data.type === "INIT_TASKS" || data.dailyTasks) {
          if (data.dailyTasks && Array.isArray(data.dailyTasks) && data.dailyTasks.length > 0) {
              taskDatabase = data.dailyTasks;
          } else if (data.tasks) {
              taskDatabase = data.tasks;
          }
      }
    
      // NEW: Listen for hierarchy from CMS
      if (data.type === "INIT_HIERARCHY" || data.hierarchy) {
          const incoming = data.hierarchy || data.hierarchyData;
          if (Array.isArray(incoming)) {
              cmsHierarchyData = incoming;
          }
      }
    
      else if (data.type === "INIT_WISHLIST" || data.wishlist) {
        if (data.wishlist && Array.isArray(data.wishlist) && data.wishlist.length > 0) {
            WISHLIST_ITEMS = data.wishlist;
            renderWishlist('all');
        }
      }
    
      // DOM STATUS & FEED
      if (data.type === "UPDATE_DOM_STATUS") {
          const badge = document.getElementById('chatStatusBadge');
          const ring = document.getElementById('chatStatusRing');
          const domBadge = document.getElementById('domStatusBadge');
          const domRing = document.getElementById('statusRing');
          
          if(badge) {
              badge.innerHTML = data.online ? "ONLINE" : data.text;
              badge.className = data.online ? "chat-status-text chat-online" : "chat-status-text";
          }
          if(ring) ring.className = data.online ? "dom-status-ring ring-active" : "dom-status-ring ring-inactive";
          if(domBadge) {
             domBadge.innerHTML = data.online ? '<span class="status-dot"></span> ONLINE' : `<span class="status-dot"></span> ${data.text}`;
             domBadge.className = data.online ? "dom-status status-online" : "dom-status";
          }
          if(domRing) domRing.className = data.online ? "dom-status-ring ring-active" : "dom-status-ring ring-inactive";
      }
    
      // *** NEW LISTENER FOR FEED ***
      if (data.type === "UPDATE_Q_FEED") {
          if (data.domVideos && Array.isArray(data.domVideos)) {
              renderDomVideos(data.domVideos);
              renderNews(data.domVideos);
          }
      }
    
      // UNIVERSAL DATA
      const payload = data.profile || data.galleryData || data.pendingState ? data : null;
      if (payload) {
            if (payload.profile) {
                // 1. Spread all data (this captures gameStats.kneelCount from CMS)
                gameStats = { ...gameStats, ...payload.profile };
                
                userProfile.name = payload.profile.name || "Slave";
                userProfile.hierarchy = payload.profile.hierarchy || "Newbie";
                userProfile.memberId = payload.profile.memberId || "";
                userProfile.joined = payload.profile.joined; 
                
                // --- KNEEL UPDATE SYNC ---
                if (payload.profile.lastWorship) {
                    lastWorshipTime = new Date(payload.profile.lastWorship).getTime();
                }
                
                // 2. FIX: Connect to kneelCount field instead of points
                if(document.getElementById('kneelCount')) {
                    document.getElementById('kneelCount').innerText = payload.profile.kneelCount || 0;
                }
                
                // 3. Force Update Button Visuals (now using kneelCount)
                updateDevotionStatus(); 
                // --------------------------
    
                stats = { ...stats, ...payload.profile.stats };  
                stats = migrateGameStatsToStats(gameStats, stats);
                
                if(payload.profile.profilePicture) { 
                    userProfile.avatar = payload.profile.profilePicture; 
                    document.getElementById('profilePic').src = getOptimizedUrl(userProfile.avatar, 150); 
                }
                
                updateStats();
            }
    
          if (payload.galleryData) {
              let rawGallery = payload.galleryData;
              if (typeof rawGallery === 'string') { try { rawGallery = JSON.parse(rawGallery); } catch(e) { rawGallery = []; } }
              
              if (Array.isArray(rawGallery)) {
                  let serverGallery = rawGallery.filter(item => {
                      if (!item.status) return false;
                      const s = item.status.toLowerCase();
                      if (s.includes('skip') || s.includes('fail') || s.includes('cancel')) return false;
                      if (!item.proofUrl || item.proofUrl.length < 5) return false;
                      return true; 
                  });
                  const currentGalleryJson = JSON.stringify(serverGallery);
                  if (currentGalleryJson !== lastGalleryJson) {
                      lastGalleryJson = currentGalleryJson;
                      galleryData = serverGallery; 
                      renderGallery(); 
                      updateStats();
                  }
              }
          }
    
          if (payload.pendingState !== undefined) {
               if (!taskJustFinished && !ignoreBackendUpdates) {
                  pendingTaskState = payload.pendingState;
                  if (pendingTaskState) {
                      if (!currentTask || currentTask.text !== pendingTaskState.task.text) { 
                          currentTask = pendingTaskState.task; 
                          restorePendingUI(); 
                      } 
                  } else { 
                      if (currentTask && !document.getElementById('cooldownSection').classList.contains('hidden')) { 
                      } else { 
                          currentTask = null; 
                          if(!resetUiTimer) {
                               document.getElementById('cooldownSection').classList.add('hidden');
                               document.getElementById('activeBadge').classList.remove('show');
                               document.getElementById('mainButtonsArea').classList.remove('hidden');
                               document.getElementById('taskContent').innerHTML = `<h2 id="readyText" style="font-weight:bold; margin-bottom:5px; color:white; font-size:1.5rem;">Ready?</h2><p class="rajdhani" style="color:#aaa; margin:0;">Waiting for orders.</p>`;
                          }
                      } 
                  }
               }
          }
      }
    
      if (data.type === "UPDATE_CHAT" || data.chatHistory) {
          const msgs = data.chatHistory || data.messages; 
          if(msgs) renderChat(msgs);
      }
    });

    /* --- UI FUNCTIONS --- */
    function switchTab(mode) {
        // 1. Highlight Active Button
        const allBtns = document.querySelectorAll('.tab-btn');
        allBtns.forEach(b => b.classList.remove('active'));
        
        currentView = mode;
        
        // Find and highlight the button for this mode
        allBtns.forEach(btn => {
            if (btn.getAttribute('onclick').includes(mode)) {
                btn.classList.add('active');
            }
        });

        // 2. MOBILE LOGIC: Hide buttons if not on Home
        if (window.innerWidth < 768) {
            allBtns.forEach(btn => {
                const cmd = btn.getAttribute('onclick') || "";
                
                if (mode === 'serve') {
                    // We are on HOME: Show everything
                    btn.classList.remove('nav-hidden');
                } else {
                    // We are on a SUB-PAGE: Hide everything first
                    btn.classList.add('nav-hidden');
                    
                    // Then SHOW only Home and Current
                    if (cmd.includes('serve') || cmd.includes(mode)) {
                        btn.classList.remove('nav-hidden');
                    }
                }
            });
        }
        
        // 3. Switch Views (Standard logic)
        ['viewServingTop','viewTribute','viewSession','viewRewards','viewHierarchy','viewNews','viewBuy','viewProtocol'].forEach(id => {
            const el = document.getElementById(id); 
            if(el) el.classList.add('hidden');
        });

        if(mode === 'serve') document.getElementById('viewServingTop').classList.remove('hidden');
        if(mode === 'tribute') document.getElementById('viewTribute').classList.remove('hidden');
        if(mode === 'session') document.getElementById('viewSession').classList.remove('hidden');
        if(mode === 'rewards') document.getElementById('viewRewards').classList.remove('hidden');
        if(mode === 'hierarchy') document.getElementById('viewHierarchy').classList.remove('hidden');
        if(mode === 'buy') document.getElementById('viewBuy').classList.remove('hidden');
        
        if(mode === 'protocol') {
            document.getElementById('viewProtocol').classList.remove('hidden');
            // When opening the tab, ensure everything is visible
            document.querySelectorAll('.protocol-item').forEach(item => {
                item.style.display = 'block';
                item.classList.remove('active');
            });
        }
        
        if(mode === 'news') {
            document.getElementById('viewNews').classList.remove('hidden');
            window.parent.postMessage({ type: "LOAD_Q_FEED" }, "*");
        }
        
        // Bottom Section logic (Evidence Log only on Home)
        const bottom = document.getElementById('viewServingBottom');
        if(bottom) bottom.style.display = (mode === 'serve') ? 'block' : 'none';
        
        // Render Triggers
        if(mode === 'hierarchy') {
            // FIX: Prioritize CMS hierarchy if available
            renderHierarchy(cmsHierarchyData || CMS_HIERARCHY);
        }
        if(mode === 'tribute') renderWishlist('all');
        if(mode === 'serve') renderGallery();
    }

    function toggleStats() { document.getElementById('statsContent').classList.toggle('open'); }

    /* --- TASK LOGIC --- */
    function getRandomTask() {
        ignoreBackendUpdates = true; 
        if (resetUiTimer) { clearTimeout(resetUiTimer); resetUiTimer = null; }
        
        let taskText = "Waiting for orders...";
        if (taskQueue && taskQueue.length > 0) {
            taskText = taskQueue[0];
        } else {
            if (taskDatabase && taskDatabase.length > 0) {
                taskText = taskDatabase[Math.floor(Math.random()*taskDatabase.length)];
            }
        }
        
        currentTask = { text: taskText, category: 'general', timestamp: Date.now() }; 
        const endTimeVal = Date.now() + 86400000;
        pendingTaskState = { task: currentTask, endTime: endTimeVal, status: "PENDING" };
        restorePendingUI();
        window.parent.postMessage({ type: "savePendingState", pendingState: pendingTaskState, consumeQueue: true }, "*");
        setTimeout(() => { ignoreBackendUpdates = false; }, 5000);
    }

    function restorePendingUI() {
        if (resetUiTimer) { clearTimeout(resetUiTimer); resetUiTimer = null; }
        document.getElementById('mainButtonsArea').classList.add('hidden'); 
        document.getElementById('activeBadge').classList.add('show');
        document.getElementById('taskContent').innerHTML = `<div style="font-size:1.2rem; font-weight:bold;">${currentTask.text}</div>`;
        document.getElementById('cooldownSection').classList.remove('hidden');
        if(cooldownInterval) clearInterval(cooldownInterval);
        const targetTime = parseInt(pendingTaskState.endTime);
        cooldownInterval = setInterval(() => {
             if(!targetTime) return;
             const diff = targetTime - Date.now();
             if(diff <= 0) { 
                 // --- AUTO FAIL LOGIC (300 COIN FINE) ---
                 clearInterval(cooldownInterval); 
                 document.getElementById('timerDisplay').textContent="00:00:00"; 
                 cancelPendingTask(); // This triggers the fine logic
                 return; 
             }
             const h = Math.floor(diff/3600000).toString().padStart(2,'0');
             const m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0');
             const s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
             document.getElementById('timerDisplay').textContent = `${h}:${m}:${s}`;
        }, 1000);
    }

    function finishTask(success) {
        taskJustFinished = true; 
        pendingTaskState = null; 
        clearInterval(cooldownInterval);
        document.getElementById('celebrationOverlay').classList.add('active');
        setTimeout(() => { document.getElementById('celebrationOverlay').classList.remove('active'); }, 2500);
        resetTaskDisplay(success);
        setTimeout(() => { taskJustFinished = false; ignoreBackendUpdates = false; }, 5000);
    }
    
    function cancelPendingTask() { 
        if(!currentTask) return;
        
        // --- COIN CHECK (300 COIN FINE) ---
        if (gameStats.coins < 300) {
             triggerSound('sfx-deny');
             // Fake system message
             const chatContent = document.getElementById('chatContent');
             chatContent.innerHTML += `<div class="msg-row system-row"><div class="msg-system sys-red"><svg class="sys-icon"><use href="#icon-close"></use></svg>CANNOT AFFORD SKIP (300)</div></div>`;
             document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
             return;
        }
        // ---------------------------------
        
        triggerSound('skipSound');
        window.parent.postMessage({ type: "taskSkipped", taskTitle: currentTask.text }, "*"); 
        finishTask(false); 
    }

    function resetTaskDisplay(success) {
        document.getElementById('cooldownSection').classList.add('hidden');
        document.getElementById('activeBadge').classList.remove('show');
        document.getElementById('mainButtonsArea').classList.remove('hidden');
        document.getElementById('taskContent').innerHTML = `<h2 style="font-weight:bold; font-size:1.5rem; color:${success?'var(--neon-yellow)':'var(--neon-red)'}">${success?'GOOD BOY.':'PATHETIC.'}</h2>`;
        currentTask = null;
        if (resetUiTimer) clearTimeout(resetUiTimer);
        resetUiTimer = setTimeout(() => {
             document.getElementById('taskContent').innerHTML = `<h2 id="readyText" style="font-weight:bold; margin-bottom:5px; color:white; font-size:1.5rem;">Ready?</h2><p class="rajdhani" style="color:#aaa; margin:0;">Waiting for orders.</p>`;
             resetUiTimer = null;
        }, 3000);
    }

    /* --- CHAT LOGIC (FORCE BUBBLES + SCROLL FIX + ANTI BLINK) --- */
    function renderChat(messages) {
        const chatBoxContainer = document.getElementById('chatBox');
        const chatContent = document.getElementById('chatContent');
        const loadMoreBtn = document.getElementById('chatLoadMoreBtn');
        
        if(!messages) return;
        messages.sort((a,b) => new Date(a._createdDate) - new Date(b._createdDate));
        
        // Anti-Blink
        const currentJson = JSON.stringify(messages);
        if (currentJson === lastChatJson) return; 
        
        const isAtBottom = (chatBoxContainer.scrollHeight - chatBoxContainer.scrollTop - chatBoxContainer.clientHeight) < 150;
        const wasInitialLoad = isInitialLoad;

        // --- NOTIFICATION LOGIC (SOUND & GLASS) ---
        if (!isInitialLoad) {
            const lastMsg = messages[messages.length-1];
            
            // If the last message is NEW and NOT from the slave ('user')
            if (lastMsg._id !== lastNotifiedMessageId && lastMsg.sender !== 'user') {
                
                // 1. PLAY SOUND: Triggers for both System and Admin messages
                triggerSound('msgSound');

                // 2. BREAK GLASS: Triggers for both System and Admin messages
                // We removed the 'system' check so it pops up for your messages too
                const glassOverlay = document.getElementById('specialGlassOverlay');
                if (glassOverlay) {
                    glassOverlay.classList.add('active');
                }

                lastNotifiedMessageId = lastMsg._id;
            }
        }
        // ------------------------------------------
        lastChatJson = currentJson; isInitialLoad = false;
        
        loadMoreBtn.style.display = messages.length > chatLimit ? 'block' : 'none';
        const visibleMessages = messages.slice(Math.max(messages.length - chatLimit, 0));
        
        chatContent.innerHTML = visibleMessages.map(m => {
            let txt = m.message.replace(/<[^>]+>/g, "").trim();
            const isMe = m.sender === 'user';
            const isSystem = m.sender === 'system';
            
            // 1. SYSTEM MESSAGES (GREY DEFAULT)
            if (isSystem) {
                let sysClass = ""; // Default Grey (transparent bg via CSS)
                let sysIcon = "#icon-check";
                const lower = txt.toLowerCase();
                
                // ONLY Money is Gold
                if (lower.includes("tribute") || lower.includes("coins") || lower.includes("purchase") || lower.includes("sent")) { 
                    sysClass = "sys-gold"; sysIcon = "#icon-coin"; 
                }
                // Errors Red
                else if (lower.includes("insufficient") || lower.includes("poor") || lower.includes("rejected")) {
                    sysClass = "sys-red"; sysIcon = "#icon-close";
                }
                
                txt = txt.replace(/‚úÖ|‚ùå|‚õî|üéÅ|ü™ô/g, "").trim();
                return `<div class="msg-row system-row"><div class="msg-system ${sysClass}"><svg class="sys-icon"><use href="${sysIcon}"></use></svg>${txt}</div></div>`;
            }

            // 2. ADMIN/USER MESSAGES
            let msgClass = isMe ? 'm-slave' : 'm-queen';
            
            // Admin Verdict Colors
            if (!isMe) {
                if (txt.includes("Verified") || txt.includes("Task Verified")) msgClass = 'm-approve';
                else if (txt.includes("Rejected") || txt.includes("Task Rejected")) msgClass = 'm-reject';
            }

            let contentHtml = `<div class="msg ${msgClass}">${txt}</div>`;
            
            // 3. MEDIA DETECTION (Includes Video Fix)
            if (m.message.startsWith('http')) {
                const url = m.message;
                const lowerUrl = url.toLowerCase();
                
                // Video Check
                const isVideo = lowerUrl.includes("#.mp4") || lowerUrl.match(/\.(mp4|webm|mov)($|\?)/) || m.type === 'video';

                // Image Check
                const isImage = !isVideo && (
                    lowerUrl.match(/\.(jpeg|jpg|gif|png|webp|bmp)($|\?)/) || 
                    lowerUrl.includes("wixstatic") || 
                    lowerUrl.includes("cloudinary") || 
                    lowerUrl.includes("upcdn.io")
                );

                if (isVideo) {
                    contentHtml = `<div class="msg ${msgClass}" style="padding:0; background:black;">
                        <video src="${url}" controls preload="metadata" onclick="openChatPreview('${encodeURIComponent(url)}', true)" style="max-width:100%; border-radius:8px; display:block; cursor:pointer;" onloadedmetadata="forceBottom()"></video>
                    </div>`;
                } 
                else if (isImage) {
                    const encUrl = encodeURIComponent(url);
                    contentHtml = `<div class="msg ${msgClass}" style="padding:0;">
                        <img src="${url}" class="gm-img" style="border-radius:8px; cursor:pointer;" loading="lazy" onclick="openChatPreview('${encUrl}', false)" onload="forceBottom()">
                    </div>`;
                } 
                else {
                    contentHtml = `<div class="msg ${msgClass}"><a href="${url}" target="_blank" rel="noopener noreferrer" style="text-decoration:underline;">LINK</a></div>`;
                }
            }

            // Timestamp Layout (Side by Side)
            let rowContent = "";
            const avatar = isMe ? "" : `<img src="${QUEEN_AVATAR}" class="msg-avatar">`;
            const timeDiv = `<div class="msg-time">${new Date(m._createdDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
            
            if (isMe) {
                 rowContent = `<div class="msg-col" style="justify-content: flex-end;">${contentHtml} ${timeDiv}</div>`;
            } else {
                 rowContent = `${avatar}<div class="msg-col" style="justify-content: flex-start;">${contentHtml} ${timeDiv}</div>`;
            }

            return `<div class="msg-row ${isMe?'mr-out':'mr-in'}">${rowContent}</div>`;
        }).join('');

        if (wasInitialLoad || isAtBottom) {
            forceBottom();
            setTimeout(forceBottom, 100);
            setTimeout(forceBottom, 500); 
        }
    }
    
    // --- FORCE SCROLL HELPER ---
    function forceBottom() {
        const b = document.getElementById('chatBox');
        if(b) b.scrollTop = b.scrollHeight;
    }

    // --- PROTOCOL TOGGLE LOGIC (EXCLUSIVE FOCUS + ARROWS) ---
    function toggleSection(element) {
        const allItems = document.querySelectorAll('.protocol-item');
        const isActive = element.classList.contains('active');

        if (!isActive) {
            // OPENING: Hide everything else completely
            allItems.forEach(item => {
                if (item === element) {
                    item.classList.add('active');
                    item.style.display = 'block';
                    const itemArrow = item.querySelector('.protocol-arrow');
                    if (itemArrow) itemArrow.innerText = '‚ñ≤';
                } else {
                    item.style.display = 'none'; // They vanish
                }
            });
        } else {
            // CLOSING: Show everything again
            allItems.forEach(item => {
                item.classList.remove('active');
                item.style.display = 'block'; // They return
                const itemArrow = item.querySelector('.protocol-arrow');
                if (itemArrow) itemArrow.innerText = '‚ñº';
            });
        }
    }

    // --- NEW INTERNAL CHAT PREVIEW FUNCTIONS ---
    function openChatPreview(encUrl, isVideo) {
        const url = decodeURIComponent(encUrl);
        const overlay = document.getElementById('chatMediaOverlay');
        const content = document.getElementById('cmoContent');
        if (isVideo) { content.innerHTML = `<video src="${url}" controls autoplay class="cmo-media" style="pointer-events:auto;"></video>`; } 
        else { content.innerHTML = `<img src="${url}" class="cmo-media">`; }
        overlay.classList.add('active');
    }
    function closeChatPreview() {
        const overlay = document.getElementById('chatMediaOverlay');
        overlay.classList.remove('active');
        document.getElementById('cmoContent').innerHTML = ""; 
    }

    function loadMoreChat() { chatLimit += 10; const oldJson = lastChatJson; lastChatJson = ""; renderChat(JSON.parse(oldJson)); }
    function sendChatMessage() { const input = document.getElementById('chatMsgInput'); const txt = input.value.trim(); if(!txt) return; window.parent.postMessage({ type: "SEND_CHAT_TO_BACKEND", text: txt }, "*"); input.value = ""; }
    function handleChatKey(e) { if(e.key === 'Enter') sendChatMessage(); }

    function createPendingCardHTML(item) {
        const cleanText = cleanHTML(item.text).replace(/"/g, '&quot;');
        const isVideo = item.proofType === 'video' || item.proofUrl.match(/\.(mp4|webm|mov)$/i);
        let thumb = getOptimizedUrl(item.proofUrl, 400);
        
        const encUrl = encodeURIComponent(item.proofUrl || "");
        const encText = encodeURIComponent(item.text || "");
        const encStatus = encodeURIComponent("PENDING REVIEW");

        return `<div class="pending-card" onclick="openHistoryModal(galleryData.indexOf(item))">
                    <div class="pc-media"><img src="${thumb}" class="pc-thumb" loading="lazy"><div class="pc-gradient"></div><div class="absolute inset-0 flex items-center justify-center z-10"><svg class="w-8 h-8 fill-yellow-400 drop-shadow-md"><use href="#icon-timer"></use></svg></div></div>
                    <div class="pc-content"><div class="pc-badge">PENDING</div><div class="pc-title">${cleanText}</div></div>
                </div>`;
    }
    
    // Change the first line to include index
      function createGalleryItemHTML(item, index) {
          if(!item.proofUrl) return '';
          let statusClass = item.status === 'approve' ? 'st-approve' : (item.status === 'reject' ? 'st-reject' : 'st-pending');
          let statusText = item.status === 'approve' ? 'APPROVED' : (item.status === 'reject' ? 'REJECTED' : 'PENDING');
          let overlayHtml = item.status === 'reject' ? '<div class="rejected-overlay"></div>' : '';
          const isVideo = item.proofType === 'video' || item.proofUrl.match(/\.(mp4|webm|mov)$/i);
          let thumbUrl = getOptimizedUrl(item.proofUrl, 300);

          let mediaHtml = isVideo ? `<img src="${thumbUrl}" class="gi-thumb" loading="lazy"><div class="gi-play-icon" style="display:block;">‚ñ∂</div>` : `<img src="${thumbUrl}" class="gi-thumb" style="opacity:0.7;" loading="lazy">`;

          let stickerHtml = item.sticker ? `<img src="${item.sticker}" class="gi-sticker" title="Awarded">` : '';

          // CHANGE: The onclick now calls openHistoryModal(index)
          return `<div class="gallery-item ${isVideo?'video-item':''}" onclick='openHistoryModal(${index})'>
                      ${overlayHtml}
                      ${mediaHtml}
                      ${stickerHtml}
                      <div class="gi-badge ${statusClass}">${statusText}</div>
                  </div>`;
      }

  
                let currentHistoryIndex = 0;
                let touchStartX = 0;
                let activeHistoryItem = null; // New: Stores the current item for mode switching
                
                // 1. MAIN FUNCTION: Opens the card and fills it with CMS data
                function openHistoryModal(index) {
                    const item = galleryData[index];
                    if(!item) return;
                
                    currentHistoryIndex = index;
                    activeHistoryItem = item; // Stores item for the mode buttons
                
                    // A. SET BACKGROUND (Shows Sub's proof by default)
                    setMediaLayer(item.proofUrl);
                
                    // B. POPULATE STATUS (Big Badge)
                    const statusEl = document.getElementById('modalStatus');
                    const s = (item.status || "REVIEW").toUpperCase();
                    statusEl.innerText = s;
                    statusEl.style.color = s.includes('APP') ? 'var(--neon-green)' : 'var(--neon-red)';
                
                    // C. POPULATE POINTS (From CMS)
                    document.getElementById('modalPoints').innerText = `+${item.points || item.score || 0} PTS`;
                
                    // D. POPULATE STICKER
                    document.getElementById('modalSticker').innerHTML = item.sticker ? `<img src="${item.sticker}" style="width:60px; filter:drop-shadow(0 0 10px white);">` : "";
                
                    // E. POPULATE QUEEN FEEDBACK ROW (Media Left, Nav Right)
                    const fMedia = document.getElementById('modalFeedbackMedia');
                    const feedbackRow = document.getElementById('feedbackRow');
                    if (item.adminMedia) {
                        feedbackRow.style.display = "flex";
                        const isVid = item.adminMedia.match(/\.(mp4|webm|mov)$/i);
                        fMedia.innerHTML = isVid ? `<video src="${item.adminMedia}"></video>` : `<img src="${item.adminMedia}">`;
                    } else {
                        feedbackRow.style.display = "none";
                    }
                
                    // F. POPULATE HIDDEN TEXT AREAS
                    document.getElementById('modalFeedbackText').innerText = item.adminComment || "No comment.";
                    document.getElementById('modalOrderText').innerText = item.text || "No task details found.";
                
                    // G. RESET VIEW TO DEFAULT CARD
                    toggleHistoryView('info');
                
                    // H. SHOW THE WINDOW
                    const modal = document.getElementById('glassModal');
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                }
                
                // 2. VIEW SWITCHER: Swaps between Proof, Task, Comment, and Queen Zoom
                function toggleHistoryView(view, event) {
                    if (event) event.stopPropagation(); // Prevents clicking buttons from closing the modal
                
                    const card = document.getElementById('reviewCard');
                    const orderText = document.getElementById('modalOrderText');
                    const feedbackText = document.getElementById('modalFeedbackText');
                
                    // Default: Hide all overlays
                    card.classList.add('hidden');
                    orderText.classList.add('hidden');
                    feedbackText.classList.add('hidden');
                
                    if (view === 'info') {
                        // SHOW: Status, Points, Sticker, Feedback Row
                        card.classList.remove('hidden');
                        setMediaLayer(activeHistoryItem.proofUrl);
                    } 
                    else if (view === 'task') {
                        // SHOW: Only the original Orders in center
                        orderText.classList.remove('hidden');
                    }
                    else if (view === 'comment') {
                        // SHOW: The Card and the Text Bubble
                        card.classList.remove('hidden');
                        feedbackText.classList.remove('hidden');
                    }
                    else if (view === 'proof') {
                        // HIDE EVERYTHING: Clear view of sub's submitted photo
                        setMediaLayer(activeHistoryItem.proofUrl);
                    }
                    else if (view === 'queen_media') {
                        // ZOOM: Queen's photo/video covers the card area
                        setMediaLayer(activeHistoryItem.adminMedia);
                    }
                }
                
                // 3. MEDIA HELPER: Swaps background media container safely
                function setMediaLayer(url) {
                    const container = document.getElementById('modalMediaContainer');
                    if (!container || !url) return;
                    const isVid = url.match(/\.(mp4|webm|mov)$/i);
                    container.innerHTML = isVid ?
                        `<video src="${url}" autoplay loop muted style="width:100%; height:100%; object-fit:contain;"></video>` :
                        `<img src="${url}" style="width:100%; height:100%; object-fit:contain;">`;
                }
                
                // 3. SWIPE DETECTION: Core Listeners (Logic preserved)
                const modalEl = document.getElementById('glassModal');
                modalEl.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
                modalEl.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const diff = touchStartX - touchEndX;
                    if (Math.abs(diff) > 70) {
                        if (diff > 0) { openHistoryModal(currentHistoryIndex + 1); } 
                        else { openHistoryModal(currentHistoryIndex - 1); }
                    }
                }, { passive: true });

  
    function renderGallery() {
        const hGrid = document.getElementById('historyGrid');
        const pGrid = document.getElementById('pendingGrid');
        
        // Safety check for empty data
        if (!galleryData || galleryData.length === 0) return;
    
        const hItems = galleryData.filter(i => i.status && i.status.toLowerCase() !== 'pending');
        const pItems = galleryData.filter(i => i.status && i.status.toLowerCase() === 'pending');
    
        hGrid.innerHTML = hItems.map(item => `
            <div class="gallery-item" onclick="openHistoryModal(${galleryData.indexOf(item)})" style="position:relative; aspect-ratio:1; background:#000; border-radius:8px; overflow:hidden; border:1px solid #333;">
                <img src="${item.proofUrl}" style="width:100%; height:100%; object-fit:cover; opacity:0.6;">
                ${item.sticker ? `<img src="${item.sticker}" style="position:absolute; top:2px; right:2px; width:20px; z-index:10;">` : ''}
                <div style="position:absolute; bottom:5px; left:5px; font-size:0.5rem; background:rgba(0,0,0,0.8); padding:2px 5px; border-radius:3px; color: ${item.status.toLowerCase().includes('app') ? 'var(--neon-green)' : 'var(--neon-red)'}">${item.status.toUpperCase()}</div>
            </div>`).join('');
            
        pGrid.innerHTML = pItems.map(item => `
            <div onclick="openHistoryModal(${galleryData.indexOf(item)})" style="aspect-ratio:1.5; background:#111; border-radius:10px; overflow:hidden; position:relative; border:1px solid var(--neon-yellow);">
                <img src="${item.proofUrl}" style="width:100%; height:100%; object-fit:cover; opacity:0.4;">
                <div style="position:absolute; bottom:10px; left:10px; font-weight:bold; font-size:0.7rem; color:var(--neon-yellow);">PENDING REVIEW</div>
            </div>`).join('');
    
        document.getElementById('pendingSection').style.display = pItems.length > 0 ? 'block' : 'none';
        document.getElementById('historySection').style.display = 'block';
    }
  
    function loadMoreHistory() { historyLimit += 25; renderGallery(); }


        mediaZone.style.display = "flex";
        mediaZone.innerHTML = isVideo ? `<video src="${url}" class="gm-img" controls autoplay></video>` : `<img src="${url}" class="gm-img">`;
        
        document.querySelector('.gm-info-zone').style.height = "40%";
        
        let feedbackHtml = "";
        if (adminComment || adminMedia) {
            feedbackHtml = `<div style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border:1px solid #333; border-radius:8px; position:relative;">
                <div style="font-size:0.65rem; color:var(--neon-pink); font-weight:900; margin-bottom:8px; letter-spacing:1px; text-transform:uppercase;">QUEEN'S FEEDBACK</div>`;
            
            if (adminMedia) {
                const isAdmVideo = adminMedia.endsWith('.mp4');
                if(isAdmVideo) feedbackHtml += `<video src="${adminMedia}" controls style="width:100%; border-radius:4px; margin-bottom:8px; border:1px solid #444;"></video>`;
                else feedbackHtml += `<img src="${adminMedia}" style="width:100%; border-radius:4px; margin-bottom:8px; border:1px solid #444;">`;
            }
            if (adminComment) {
                feedbackHtml += `<div style="font-family:'Rajdhani'; color:white; font-size:0.95rem; line-height:1.4;">"${adminComment}"</div>`;
            }
            feedbackHtml += `</div>`;
        }

        let stickerDisplay = "";
        if (sticker) {
            stickerDisplay = `<div style="display:flex; justify-content:center; margin-bottom:5px;">
                <img src="${sticker}" style="width:60px; height:60px; object-fit:contain; filter:drop-shadow(0 0 5px rgba(255,255,255,0.5));">
            </div>`;
        }

        document.querySelector('.gm-info-zone').innerHTML = `
            <div id="modalText" class="modal-task-text" style="font-size:1.1rem; margin-bottom:10px;">${text || ""}</div>
            ${feedbackHtml}
            <div style="margin-top: auto; display:flex; flex-direction:column; align-items:center; gap:5px; border-top:1px solid #333; padding-top:15px;">
                ${stickerDisplay}
                <div class="modal-status-label" style="font-size:0.65rem; letter-spacing:2px; color:#666;">STATUS</div>
                <div id="modalStatus" class="modal-status-val" style="font-size:2rem; font-weight:900; color:${statusColor}; text-shadow:${statusShadow}; letter-spacing:3px;">${status || ""}</div>
            </div>
            <button onclick="closeModal(null)" class="action-btn" style="background:#222; color:white; font-size:0.75rem; padding: 10px; margin-top: 20px;">CLOSE</button>
        `;
        document.getElementById('glassModal').classList.add('active');
    }
    
    function closeModal() { document.getElementById('glassModal').classList.remove('active'); }

    // --- 1. RENDER HIGHLIGHTS (Reel) ---
    function renderDomVideos(videos) {
        const reel = document.getElementById('domVideoReel');
        if(!reel) return;
        if(!videos || videos.length === 0) { reel.innerHTML = `<div style="color:#444; font-size:0.7rem; padding:10px;">No highlights.</div>`; return; }
        const cnt = document.getElementById('cntPosts');
        if(cnt) cnt.innerText = videos.length;
        reel.innerHTML = videos.map(item => {
            const mediaUrl = item.page; 
            const caption = item.post || "Clip";
            if (!mediaUrl) return "";
            const thumbUrl = getOptimizedUrl(mediaUrl, 300);
            return `
            <div class="hl-item" onclick="openNewsCard('${caption.replace(/'/g, "\\'")}', '', '${mediaUrl}')">
                <div class="hl-circle"><img src="${thumbUrl}" class="hl-img" loading="lazy"></div>
                <div class="hl-title">${caption}</div>
            </div>`;
        }).join('');
    }

    // --- 2. RENDER FEED GRID (News) ---
    function renderNews(data) {
        const grid = document.getElementById('newsGrid');
        if(!grid) return;
        grid.innerHTML = data.map(item => {
            let contentHtml = '';
            let icon = '';
            const img = item.img || item.page;
            const title = item.title || item.post || "UPDATE";
            const body = item.content || "";

            if (img) {
                const thumb = getOptimizedUrl(img, 300);
                contentHtml = `<img src="${thumb}" class="sg-img" loading="lazy">`;
                icon = 'üì∑';
            } else {
                const shortText = title ? title : "UPDATE";
                contentHtml = `<div class="sg-text">${shortText}</div>`;
                icon = 'üìù';
            }
            return `
            <div class="sg-item" onclick="openNewsCard('${title.replace(/'/g, "\\'")}', '${body.replace(/'/g, "\\'")}', '${img || ""}')">
                <div class="sg-icon">${icon}</div>
                ${item.type === 'URGENT' ? '<div class="sg-new">!</div>' : ''}
                ${contentHtml}
            </div>`;
        }).join('');
    }

    // --- 3. HELPER: OPEN CARD MODAL ---
    function openNewsCard(title, body, imgUrl) {
        const modal = document.getElementById('glassModal');
        const mediaZone = document.getElementById('modalMediaContainer');
        const textZone = document.getElementById('modalText');
        const statusZone = document.getElementById('modalStatus');
        if(imgUrl) {
            const isVideo = imgUrl.includes('.mp4') || imgUrl.includes('.mov');
            mediaZone.innerHTML = isVideo ? `<video src="${imgUrl}" class="gm-img" controls autoplay></video>` : `<img src="${imgUrl}" class="gm-img">`;
            mediaZone.style.display = 'flex';
        } else { mediaZone.style.display = 'none'; }
        textZone.innerHTML = `<h3 style="color:var(--neon-pink); font-size:1.5rem; margin-bottom:10px; line-height:1.1;">${title}</h3><div style="font-family:'Rajdhani'; font-size:1rem; color:#ccc; line-height:1.4;">${body}</div>`;
        statusZone.innerText = "VIEWING";
        document.querySelector('.gm-content').style.maxWidth = "600px"; 
        if(!imgUrl) document.querySelector('.gm-content').style.display = "flex"; 
        modal.classList.add('active');
    }

    async function handleEvidenceUpload(input) {
      try {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const fd = new FormData(); fd.append("file", file);
          const statusEl = document.getElementById("uploadStatus"); statusEl.innerText = "Uploading...";
          const folder = userProfile.name.replace(/[^a-z0-9-_]/gi, "_").toLowerCase();
          const res = await fetch(`https://api.bytescale.com/v2/accounts/${ACCOUNT_ID}/uploads/form_data?path=/evidence/${folder}`, { method: "POST", headers: { "Authorization": `Bearer ${API_KEY}` }, body: fd });
          if (!res.ok) { statusEl.innerText = "Upload failed."; return; }
          const d = await res.json();
          if (d.files && d.files[0] && d.files[0].fileUrl) {
            window.parent.postMessage({ type: "uploadEvidence", task: currentTask.text, fileUrl: d.files[0].fileUrl, mimeType: file.type }, "*");
            finishTask(true); statusEl.innerText = "Upload complete!";
          } else { statusEl.innerText = "Upload failed (unexpected response)."; }
        }
      } catch (err) { document.getElementById("uploadStatus").innerText = "Upload failed (error)."; }
    }

    async function handleProfileUpload(input) { if(input.files && input.files[0]) { const fd = new FormData(); fd.append('file', input.files[0]); fd.append('upload_preset', UPLOAD_PRESET); const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd }); const d = await res.json(); if(d.secure_url) window.parent.postMessage({ type: "UPDATE_PROFILE_PIC", url: d.secure_url }, "*"); } }
    
      function updateStats() {
      document.getElementById('subName').textContent = userProfile.name;
      document.getElementById('subHierarchy').textContent = userProfile.hierarchy;
      document.getElementById('coins').textContent = gameStats.coins;
      document.getElementById('points').textContent = gameStats.points;

      // --- NEW FIELD MAPPINGS ---
      if(document.getElementById('statStreak')) document.getElementById('statStreak').textContent = gameStats.taskdom_streak || 0;
      if(document.getElementById('statTotal')) document.getElementById('statTotal').textContent = gameStats.taskdom_total_tasks || 0;
      if(document.getElementById('statCompleted')) document.getElementById('statCompleted').textContent = gameStats.taskdom_completed_tasks || 0;
      if(document.getElementById('statSkipped')) document.getElementById('statSkipped').textContent = stats.skippedTasks || 0;
      if(document.getElementById('statTotalKneels')) document.getElementById('statTotalKneels').textContent = gameStats.kneelCount || 0;

      if (userProfile.joined) {
          try {
              const dateObj = new Date(userProfile.joined);
              document.getElementById('slaveSinceDate').textContent = dateObj.toLocaleDateString();
          } catch(e) { document.getElementById('slaveSinceDate').textContent = "--/--/--"; }
      }

      // Leave the level/progress bar logic below this exactly as it is...
      let nextLevel = LEVELS.find(l => l.min > gameStats.points) || {name: "MAX", min: gameStats.points};
      document.getElementById('nextLevelName').innerText = nextLevel.name;
      const needed = nextLevel.min - gameStats.points;
      document.getElementById('pointsNeeded').innerText = (needed > 0 ? needed : 0) + " to go";
      const prevLevel = LEVELS.slice().reverse().find(l => l.min <= gameStats.points) || {min: 0};
      const range = nextLevel.min - prevLevel.min;
      const progress = range > 0 ? ((gameStats.points - prevLevel.min) / range) * 100 : 100;
      document.getElementById('progressBar').style.width = Math.min(100, Math.max(0, progress)) + "%";

      updateDevotionStatus(); 
  }

    function openSessionUI() { document.getElementById('sessionOverlay').classList.add('active'); document.getElementById('sessionCostDisplay').innerText = "3000"; document.querySelector('input[value="chat"]').checked = true; }
    function closeSessionUI() { document.getElementById('sessionOverlay').classList.remove('active'); }
    function updateSessionCost() { const cost = document.querySelector('input[name="sessionType"]:checked').getAttribute('data-cost'); document.getElementById('sessionCostDisplay').innerText = cost; }
    function submitSessionRequest() {
        const type = document.querySelector('input[name="sessionType"]:checked').value;
        const cost = parseInt(document.querySelector('input[name="sessionType"]:checked').getAttribute('data-cost'));
        const timeSelect = document.getElementById('sessionTimeSelect');
        const selectedTimeText = timeSelect.options[timeSelect.selectedIndex].text;
        const selectedTimeVal = timeSelect.value;
        const focus = document.getElementById('sessionFocus').value;
        if(gameStats.coins < cost) { triggerSound('sfx-deny'); alert("Insufficient coins."); return; }
        gameStats.coins -= cost; document.getElementById('coins').textContent = gameStats.coins; triggerSound('sfx-buy');
        window.parent.postMessage({ type: "SESSION_REQUEST", sessionType: type, cost: cost, requestedTime: selectedTimeVal, requestedTimeLabel: selectedTimeText, focus: focus }, "*");
        document.getElementById('sessionOverlay').innerHTML = `<div style="text-align:center; padding:20px; color:white;"><div style="font-size:3rem; margin-bottom:10px;">‚úÖ</div><h2 style="font-weight:bold; margin-bottom:10px; font-family:'Orbitron';">REQUEST SENT</h2><p style="color:#aaa; font-family:'Rajdhani'; font-size:0.9rem;">${cost} coins held.<br>Waiting for Queen's confirmation.</p><button onclick="location.reload()" class="action-btn" style="margin-top:20px; font-size:0.7rem;">CLOSE</button></div>`;
    }

    function sendCoins(amount, category = "Tribute") {
        // --- MOCK POOR USERS ---
        if (gameStats.coins < amount) {
            triggerSound('sfx-deny');
            // Insert Fake Message
            const mocks = ["Too poor.", "Earn it first.", "Empty pockets?", "Pathetic wallet."];
            const text = mocks[Math.floor(Math.random() * mocks.length)];
            const chatContent = document.getElementById('chatContent');
            chatContent.innerHTML += `<div class="msg-row system-row"><div class="msg-system sys-red"><svg class="sys-icon"><use href="#icon-close"></use></svg>${text}</div></div>`;
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            return;
        }
        // -----------------------
        
        if (category !== "TAX") { triggerSound('coinSound'); triggerCoinShower(); }
        window.parent.postMessage({ type: "SEND_COINS", amount: amount, category: category }, "*");
        const btns = document.querySelectorAll('.coin-btn');
        btns.forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });
        setTimeout(() => { btns.forEach(b => { b.disabled = false; b.style.opacity = '1'; }); }, 1500);
    }
    function buyRealCoins(amount) { triggerSound('sfx-buy'); window.parent.postMessage({ type: "INITIATE_STRIPE_PAYMENT", amount: amount }, "*"); }
    function triggerCoinShower() { for(let i=0; i<40; i++) { const coin = document.createElement('div'); coin.className = 'coin-particle'; coin.innerHTML = `<svg style="width:100%; height:100%; fill:gold;"><use href="#icon-coin"></use></svg>`; coin.style.setProperty('--tx', `${Math.random()*200-100}vw`); coin.style.setProperty('--ty', `${-(Math.random()*80+20)}vh`); document.body.appendChild(coin); setTimeout(() => { coin.remove(); }, 2000); } }
    function breakGlass(e) { if(e) e.stopPropagation(); const overlay = document.getElementById('specialGlassOverlay'); if (overlay.classList.contains('active')) { overlay.classList.remove('active'); window.parent.postMessage({ type: "GLASS_BROKEN" }, "*"); } }
    function cleanHTML(html) { if(!html) return ""; let text = html.replace(/<br\s*\/?>/gi, "\n").replace(/<\/p>/gi, "\n"); text = text.replace(/<[^>]+>/g, ""); const txt = document.createElement("textarea"); txt.innerHTML = text; return txt.value.trim(); }
    function filterStore(cat, el) { document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active')); el.classList.add('active'); renderWishlist(cat); }
    function renderWishlist(filter) { const grid = document.getElementById('storeGrid'); if(!grid) return; const items = filter === 'all' ? WISHLIST_ITEMS : WISHLIST_ITEMS.filter(i => i.cat.includes(filter.toLowerCase())); grid.innerHTML = items.map(item => { const canAfford = gameStats.coins >= item.price; return `<div class="store-item ${canAfford?'can-afford':'locked'}"><div class="si-img-box"><img src="${item.img}" class="si-img"><div class="si-price">${item.price} ü™ô</div></div><div class="si-info"><div class="si-name">${item.name}</div><button id="btn-${item.id}" class="si-btn" onclick="buyItem('${item.id}')"><span>${canAfford?'üîì':'üîí'}</span> ${canAfford?'BUY NOW':'LOCKED'}</button></div></div>`; }).join(''); }
    
    function buyItem(id) {
        const item = WISHLIST_ITEMS.find(i => i.id == id); if(!item) return;
        if (gameStats.coins >= item.price) {
            gameStats.coins -= item.price; document.getElementById('coins').textContent = gameStats.coins; triggerSound('sfx-buy');
            window.parent.postMessage({ type: "PURCHASE_ITEM", itemId: item.id, itemName: item.name, cost: item.price }, "*");
            const btn = document.getElementById('btn-' + id);
            if(btn) { btn.innerHTML = "PURCHASED"; btn.style.background = "var(--neon-green)"; btn.style.color = "black"; btn.style.borderColor = "var(--neon-green)"; }
            setTimeout(() => { const activePill = document.querySelector('.cat-pill.active'); renderWishlist(activePill ? activePill.innerText.toLowerCase() : 'all'); }, 1000);
        } else { triggerSound('sfx-deny'); }
    }
    
    function renderHierarchy(data) { const grid = document.getElementById('hierarchyGrid'); if(!grid) return; const sortedData = data.sort((a,b) => a.Order - b.Order); grid.innerHTML = sortedData.map(item => { const hasSlot = item.ContactText && item.ContactText.trim() !== ""; return `<div class="rank-card rounded-lg p-3 cursor-pointer ${item.CssClass || ''}" onclick="toggleDetails(this)"><div class="flex items-center gap-2 md:gap-4"><div class="text-lg md:text-2xl">${item.Icon || ''}</div><div class="flex-1 min-w-0"><div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-1"><h3 class="text-xl font-semibold text-gray-300" style="font-family: 'Orbitron', monospace;">${item.Title}</h3><div class="flex flex-row flex-wrap gap-2"><span class="duty-chip">POINTS: ${item.Points}</span>${hasSlot ? `<span class="duty-chip">${item.ContactText}</span>` : ''}</div></div><p class="text-gray-300 text-xs md:text-sm">${item.Description || ''}</p></div><div class="text-gray-400 text-sm flex-shrink-0">‚ñº</div></div><div class="details mt-4 cms-content"><div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;"><strong class="neon-pink-text" style="font-size:0.8rem;">STATUS</strong><p>${item.StatusText}</p></div><div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;"><strong class="neon-text" style="font-size:0.8rem;">PROTOCOL</strong><div>${item.ProtocolText}</div></div><div><strong class="silver-text" style="font-size:0.8rem;">DUTIES</strong><div>${item.DutiesText}</div></div></div></div>`; }).join(''); }
    function toggleDetails(card) { const details = card.querySelector('.details'); const arrow = card.querySelector('.text-gray-400'); document.querySelectorAll('.rank-card').forEach(otherCard => { if (otherCard !== card) { const otherDetails = otherCard.querySelector('.details'); const otherArrow = otherCard.querySelector('.text-gray-400'); if(otherDetails) otherDetails.classList.remove('show'); otherCard.classList.remove('expanded'); if(otherArrow) otherArrow.textContent = '‚ñº'; } }); if (details.classList.contains('show')) { details.classList.remove('show'); card.classList.remove('expanded'); arrow.textContent = '‚ñº'; } else { details.classList.add('show'); card.classList.add('expanded'); arrow.textContent = '‚ñ≤'; } }
    
    function migrateGameStatsToStats(gameStats, stats) { return { ...stats, approvedTasks: Math.max(stats.approvedTasks, gameStats.completedTasks || 0), dailyCompletedTasks: Math.max(stats.dailyCompletedTasks, gameStats.completedTasks || 0), dailyStreak: Math.max(stats.dailyStreak, gameStats.currentStreak || 0), dailyScore: Math.max(stats.dailyScore, gameStats.points || 0), monthlyTotalTasks: Math.max(stats.monthlyTotalTasks, gameStats.totalTasks || 0), monthlyScore: Math.max(stats.monthlyScore, gameStats.points || 0) }; }
    
    setInterval(() => { window.parent.postMessage({ type: "heartbeat", view: currentView }, "*"); }, 3000);

    async function handleAdminUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const isVideo = file.type.startsWith('video') || file.name.match(/\.(mp4|mov|webm)$/i);
            const fd = new FormData();
            fd.append("file", file);

            try {
                // Visual feedback
                const btn = document.querySelector('.btn-plus');
                const oldText = btn.innerText;
                btn.innerText = "‚è≥";

                const res = await fetch(
                    `https://api.bytescale.com/v2/accounts/${ACCOUNT_ID}/uploads/form_data?path=/admin`,
                    { method: "POST", headers: { "Authorization": `Bearer ${API_KEY}` }, body: fd }
                );

                if (!res.ok) { 
                    console.error("Upload failed");
                    btn.innerText = oldText;
                    return; 
                }
                const d = await res.json();

                if (d.files && d.files[0] && d.files[0].fileUrl) {
                    let finalUrl = d.files[0].fileUrl;
                    
                    // --- VIDEO FIX: Add #.mp4 tag ---
                    if (isVideo) {
                        finalUrl = finalUrl + "#.mp4"; 
                    }
                    // --------------------------------

                    window.parent.postMessage({ type: "SEND_CHAT_TO_BACKEND", text: finalUrl }, "*")
                }
                btn.innerText = oldText;
            } catch (err) { console.error("Error", err); }
        }
    }
    
    // --- UPDATED DEVOTION LOGIC (1 HOUR TIMER) ---
    const COOLDOWN_MINUTES = 60; // 1 Hour
    let lastWorshipTime = 0; 
    let isLocked = false; 

    // --- 1. THE TIMER LOOP (Runs every second) ---
    setInterval(updateDevotionStatus, 1000);

    function updateDevotionStatus() {
        const btn = document.getElementById('btn'); 
        const txtMain = document.getElementById('txt-main'); 
        const txtSub = document.getElementById('txt-sub'); 
        const fill = document.getElementById('fill'); 
        const dailyIdEl = document.getElementById('dailyRandomId');

        if(!btn || !txtMain || !txtSub || !fill) return;

        // 1. Dashboard Sync (Admin Logic)
        const now = new Date();
        const seed = now.getUTCFullYear() * 10000 + (now.getUTCMonth() + 1) * 100 + now.getUTCDate();
        const x = Math.sin(seed) * 10000;
        const code = Math.floor((x - Math.floor(x)) * 9000) + 1000;
        if(dailyIdEl) dailyIdEl.innerText = "#" + code;

        // 2. Today's Counter from database
        const count = gameStats.todayKneeling || 0;
        txtSub.innerText = `TODAY KNEELING: ${count}`;
        txtSub.style.color = "#888"; // Keep this label grey as requested


        const timeNow = Date.now();
        const diffMs = timeNow - lastWorshipTime;
        const cooldownMs = COOLDOWN_MINUTES * 60 * 1000;

        if (lastWorshipTime > 0 && diffMs < cooldownMs) {
        isLocked = true;
        const minutesLeft = Math.ceil((cooldownMs - diffMs) / 60000);

        txtMain.innerText = `NEXT KNEELING IN: ${minutesLeft} min`;
        txtMain.style.color = "#888"; 

        // --- UPDATED: DIFFERENT SIZE FOR MOBILE VS DESKTOP ---
        // If screen is 1024px or wider, use 0.25rem (Desktop). Else use 0.35rem (Mobile).
        txtSub.style.fontSize = (window.innerWidth >= 1024) ? "0.25rem" : "0.35rem"; 

        btn.style.opacity = "0.7";
        btn.style.cursor = "not-allowed";
        fill.style.width = (100 - ((diffMs / cooldownMs) * 100)) + "%";
    } else {
        isLocked = false;

        txtMain.innerText = "KNEEL";
        txtMain.style.color = "GREY"; 

        // --- RESET SIZE TO NORMAL BASED ON SCREEN ---
        txtSub.style.fontSize = (window.innerWidth >= 1024) ? "0.25rem" : "0.35rem"; 

        btn.style.opacity = "0.7";
        btn.style.cursor = "pointer";
        fill.style.width = "0%";
    }
      }

    function handleClick() {
    if (isLocked) return;
    triggerSound('coinSound');

    // MOVE THESE UP: Visual change happens instantly now
    const fill = document.getElementById('fill');
    const txtMain = document.getElementById('txt-main');
    if (fill) fill.style.width = "100%";
    if (txtMain) txtMain.innerText = "PROCESSING...";

    isLocked = true;
    window.parent.postMessage({ type: "WORSHIP" }, "*");
    }
    // Tell Wix the UI is fully loaded and ready for data
    window.onload = () => { window.parent.postMessage({ type: "UI_READY" }, "*"); };
  
</script>
</body>
</html>
