<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Command Console</title>
  
  <script type="module" src="../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@200;300;400;600&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/reward.css">
</head>
<body>

<!-- AUDIO -->
<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<!-- HIDDEN INPUTS -->
<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
<input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="handleEvidenceUpload(this)">
<input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

<!-- CELEBRATION -->
<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green); font-family: 'Orbitron';">TASK<br>SUBMITTED</div>
    </div>
</div>

<!-- ICONS -->
<svg style="display:none;">
    <symbol id="icon-sparkles" viewBox="0 0 24 24"><path d="M9.5 1L8 4.5L4.5 6L8 7.5L9.5 11L11 7.5L14.5 6L11 4.5L9.5 1zm0 0"/><path d="M19 8.5L17.5 11L15 12.5L17.5 14L19 16.5L20.5 14L23 12.5L20.5 11L19 8.5zm0 0"/><path d="M16.5 18L15.5 20L13.5 21L15.5 22L16.5 24L17.5 22L19.5 21L17.5 20L16.5 18zm0 0"/></symbol>
</svg>

<div class="app-container">
    
    <!-- === LEFT PILLAR: IDENTITY (30%) === -->
    <div class="layout-left">
        
        <!-- 1. HIERARCHY RANK -->
        <div id="subHierarchy" class="hierarchy-top">LOADING...</div>

        <!-- 2. AVATAR -->
        <div class="avatar-container" onclick="document.getElementById('profileUploadInput').click()">
            <img id="profilePic" src="" alt="Avatar">
        </div>
        <div id="subName" class="identity-name">SLAVE</div>

        <!-- 3. BASIC STATS -->
        <div class="stats-stack">
            <div class="stat-row">
                <span class="stat-lbl">MERIT</span>
                <span id="points" class="stat-val">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-lbl">CAPITAL</span>
                <span id="coins" class="stat-val">0</span>
            </div>
        </div>

        <!-- 4. EXPANDED STATS -->
        <div class="progress-section">
            <div class="prog-labels">
                <span>NEXT: <span id="nextLevelName">-</span></span>
                <span id="pointsNeeded">0 to go</span>
            </div>
            <div class="prog-bg"><div id="progressBar" class="prog-fill"></div></div>
        </div>

        <button class="stats-toggle-btn" onclick="toggleStats()">EXPAND STATS ‚ñæ</button>
        <div id="statsContent" class="stats-panel">
            <div class="stat-line"><span>Streak</span> <strong id="statStreak">0</strong></div>
            <div class="stat-line"><span>Total Tasks</span> <strong id="statTotal">0</strong></div>
            <div class="stat-line"><span>Completed</span> <strong id="statCompleted">0</strong></div>
            <div class="stat-line"><span>Skipped</span> <strong id="statSkipped">0</strong></div>
            <div class="stat-line"><span>Total Kneeling</span> <strong id="statTotalKneels">0</strong></div>
            <div class="stat-footer">
                <span>SLAVE SINCE</span>
                <strong id="slaveSinceDate">--/--/--</strong>
            </div>
        </div>

        <!-- 5. NAVIGATION -->
        <div class="nav-menu">
            <button class="nav-btn active" onclick="switchTab('serve')">CONSOLE</button>
            <button class="nav-btn" onclick="switchTab('history')">SLAVE RECORD</button>
            <button class="nav-btn" onclick="switchTab('news')">GALLERY</button>
            <button class="nav-btn" onclick="switchTab('vault')">VAULT</button>
            <button class="nav-btn" onclick="switchTab('buy')">STORE</button>
            <button class="nav-btn" onclick="switchTab('protocol')">PROTOCOL</button>
        </div>
    </div>

    <!-- === RIGHT STAGE: OPERATIONS (70%) === -->
    <div class="layout-right">
        
        <!-- HEADER: CENTERED KNEEL BUTTON -->
        <div class="right-header">
            <div class="kneel-center-wrapper">
                <div id="btn" class="kneel-bar-graphic" 
                     onmousedown="handleHoldStart(event)" 
                     onmouseup="handleHoldEnd(event)" 
                     onmouseleave="handleHoldEnd(event)" 
                     ontouchstart="handleHoldStart(event)" 
                     ontouchend="handleHoldEnd(event)">
                    <div id="fill" class="graphic-fill"></div>
                    <span id="txt-main" class="graphic-text">HOLD TO KNEEL</span>
                </div>
            </div>
        </div>

        <!-- CONTENT STAGE -->
        <div class="content-stage">
            
            <!-- VIEW 1: CONSOLE (Task + Chat) -->
            <div id="viewServingTop" class="view-wrapper">
                
                <!-- TOP: TASK RIBBON -->
                <div id="taskCard" class="glass-card task-ribbon">
                    <div id="activeBadge" class="hidden"></div>
                    <div class="ribbon-left">
                        <div id="timerDisplay" class="ribbon-timer">00:00:00</div>
                    </div>
                    <div id="taskContent" class="ribbon-center">
                        <span class="ribbon-label">CURRENT DIRECTIVE</span>
                        <h2 id="readyText" class="ribbon-status">AWAITING ORDERS</h2>
                    </div>
                    <div class="ribbon-right">
                        <div id="mainButtonsArea">
                            <button id="newTaskBtn" onclick="getRandomTask()" class="action-btn">REQUEST TASK</button>
                        </div>
                        <div id="cooldownSection" class="hidden" style="display: flex; gap: 10px;">
                            <button onclick="document.getElementById('evidenceInput').click()" class="action-btn">UPLOAD</button>
                            <button id="btnSkip" onclick="cancelPendingTask()" class="btn-dim">SKIP</button>
                        </div>
                    </div>
                </div>

                <!-- BOTTOM: CHAT -->
                <div id="chatCard" class="chat-container">
                    <div id="chatBadge" class="hidden"></div>
                    
                    <div id="chatBody" class="chat-body-frame">
                        <div id="kneelRewardOverlay" class="hidden overlay-center"><div style="text-align: center;"><h2 style="color:white; margin-bottom: 20px; font-family:'Orbitron';">DEVOTION RECOGNIZED</h2><div style="display:flex; gap:10px;"><button onclick="claimKneelReward('coins')" class="action-btn">COINS</button><button onclick="claimKneelReward('points')" class="action-btn">POINTS</button></div></div></div>
                        <div id="chatMediaOverlay" class="hidden overlay-center"><div id="mediaOverlayClose" onclick="closeChatPreview()" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;">X</div><div id="chatMediaOverlayContent"></div></div>
                        <div id="tributeHuntOverlay" class="hidden overlay-center" style="background:#000; padding:20px; flex-direction:column;"><button onclick="toggleTributeHunt()" style="color: white; align-self:flex-end; font-family:'Orbitron'; background:none; border:none; cursor:pointer;">CLOSE</button><div id="huntStoreGrid" class="store-grid" style="margin-top: 20px;"></div><textarea id="huntNote" class="hidden"></textarea><div id="huntProgress" class="hidden"></div></div>

                        <div id="chatContent" class="chat-area"></div>
                    </div>

                    <div class="chat-footer">
                        <button id="tributeHuntBtn" onclick="toggleTributeHunt()" class="icon-btn">üéÅ</button>
                        <input type="text" id="chatMsgInput" class="chat-input" placeholder="Type..." onkeypress="handleChatKey(event)">
                        <button class="chat-send" onclick="sendChatMessage()" class="icon-btn">></button>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: STORE -->
            <div id="viewBuy" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px;"><h2 style="text-align: center; color: var(--neon-yellow); font-family:'Cinzel';">STORE</h2></div>
                <div class="store-grid">
                    <div class="store-item"><div>1K</div><button class="si-btn" onclick="buyRealCoins(1000)">‚Ç¨10.00</button></div>
                    <div class="store-item"><div>5.5K</div><button class="si-btn" onclick="buyRealCoins(5500)">‚Ç¨50.00</button></div>
                    <div class="store-item"><div>12K</div><button class="si-btn" onclick="buyRealCoins(12000)">‚Ç¨100.00</button></div>
                    <div class="store-item"><div>30K</div><button class="si-btn" onclick="buyRealCoins(30000)">‚Ç¨250.00</button></div>
                    <div class="store-item"><div>70K</div><button class="si-btn" onclick="buyRealCoins(70000)">‚Ç¨500.00</button></div>
                    <div class="store-item"><div>150K</div><button class="si-btn" onclick="buyRealCoins(150000)">‚Ç¨1000.00</button></div>
                </div>
            </div>

            <!-- VIEW 3: SLAVE RECORD (PENDING + HISTORY) -->
            <div id="historySection" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">SLAVE RECORD</h2></div>
                
                <!-- PENDING SECTION -->
                <div id="pendingSection" style="width: 100%; margin-bottom: 30px;">
                    <div style="font-family:'Cinzel'; color: var(--neon-yellow); margin-bottom: 15px; text-align: center; border-bottom:1px solid var(--neon-yellow); padding-bottom:5px;">PENDING REVIEW</div>
                    <div id="pendingGrid" class="gallery-grid"></div>
                </div>

                <!-- HISTORY LOG -->
                <div style="font-family:'Cinzel'; color: #666; margin-bottom: 15px; text-align: center; border-bottom:1px solid #333; padding-bottom:5px;">HISTORY LOG</div>
                <div id="historyGrid" class="gallery-grid"></div>
                
                <button id="loadMoreBtn" onclick="loadMoreHistory()" class="action-btn" style="display:none; margin:20px auto;">LOAD MORE...</button>
            </div>

            <!-- VIEW 4: GALLERY -->
            <div id="viewNews" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">GALLERY</h2></div>
                <div id="newsGrid" class="gallery-grid"></div>
            </div>

            <!-- VIEW 5: VAULT -->
            <div id="viewVault" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">VAULT</h2></div>
                <div id="vaultGrid" class="gallery-grid"></div>
            </div>

            <!-- VIEW 6: PROTOCOL -->
            <div id="viewProtocol" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">PROTOCOL</h2></div>
                <div style="color: #ccc; text-align: center; font-family:'Cinzel';">Obedience is the only currency.</div>
            </div>

            <!-- HIDDEN LOGIC PLACEHOLDERS -->
            <div id="viewRewards" class="hidden"></div>
            <div id="viewHierarchy" class="hidden"></div>
            <div id="viewSession" class="hidden"></div>

        </div> 
    </div>
</div>

<!-- MODAL -->
<div id="glassModal" class="glass-modal" onclick="closeModal(event)">
    <div id="modalMediaContainer" class="modal-bg-photo"></div>
    <div id="modalGlassOverlay" class="modal-glass-overlay">
        <div id="modalCloseX" onclick="closeModal(null)">√ó</div>
        <div class="theater-content">
            <div id="modalInfoView" class="sub-view"><div class="stamp-container"><img id="modalStatusSticker" src="" class="m-status-sticker-lg"></div><div class="reward-container"><div id="modalPoints" class="m-points-lg">+0 PTS</div><div id="modalSticker"></div></div></div>
            <div id="modalFeedbackView" class="sub-view hidden"><h3 class="view-label">QUEEN'S FEEDBACK</h3><div id="modalFeedbackMedia" class="fb-media-theater"></div><div id="modalFeedbackText" class="theater-text-box"></div></div>
            <div id="modalTaskView" class="sub-view hidden"><h3 class="view-label">THE ASSIGNMENT</h3><div id="modalOrderText" class="theater-text-box"></div></div>
        </div>
        <div class="modal-footer-menu">
            <button onclick="toggleHistoryView('feedback')" class="history-action-btn">FEEDBACK</button>
            <button onclick="toggleHistoryView('task')" class="history-action-btn">THE TASK</button>
            <button onclick="event.stopPropagation(); toggleHistoryView('proof')" class="history-action-btn">SEE PROOF</button>
            <button onclick="toggleHistoryView('info')" class="history-action-btn">STATUS</button>
            <button onclick="closeModal(null)" class="history-action-btn btn-close-red" style="grid-column: span 2;">CLOSE</button>
        </div>
    </div>
</div>

<script>
    // 1. Handle Includes
    document.querySelectorAll("[data-include]").forEach(async el => {
        const file = el.getAttribute("data-include");
        try { 
            const html = await fetch(file).then(r => r.text()); 
            el.innerHTML = html; 
        } catch (err) {
            console.error("Include failed:", file, err);
        }
    });

    // 2. Main Tab Switching Logic
    window.switchTab = function(viewId) {
        // Update navigation button states
        document.querySelectorAll('.nav-btn').forEach(item => {
            const onClickAttr = item.getAttribute('onclick') || "";
            if(onClickAttr.includes(`'${viewId}'`) || onClickAttr.includes(`"${viewId}"`)) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        // Define all possible view IDs
        const views = ['viewServingTop', 'viewProtocol', 'viewNews', 'viewVault', 'viewBuy', 'historySection', 'viewRewards', 'viewHierarchy', 'viewSession'];
        
        // Hide ALL views first
        views.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('hidden');
                el.style.display = 'none';
            }
        });

        // Map short keywords to actual Element IDs
        let targetId = viewId;
        if(viewId === 'serve')    targetId = 'viewServingTop';
        if(viewId === 'news')     targetId = 'viewNews';
        if(viewId === 'buy')      targetId = 'viewBuy';
        if(viewId === 'vault')    targetId = 'viewVault';
        if(viewId === 'protocol') targetId = 'viewProtocol';
        if(viewId === 'history')  targetId = 'historySection';

        const target = document.getElementById(targetId);
        if(target) {
            // Reveal the target
            target.classList.remove('hidden');
            
            // Set correct display mode
            const flexViews = ['viewNews', 'viewVault', 'viewServingTop', 'historySection'];
            if (flexViews.includes(targetId)) {
                 target.style.display = 'flex'; 
                 target.style.flexDirection = 'column';
            } else {
                 target.style.display = 'block';
            }
            
            // 3. EXECUTION FIX (Retry Logic)
            // This waits for the module to finish loading if the user clicks too fast
            const executeLogic = () => {
                // Trigger standard view logic
                if (typeof window.showView === 'function') {
                    window.showView(targetId);
                }

                // Trigger data load specifically for the Slave Record
                if (targetId === 'historySection') {
                    if (typeof window.loadMoreHistory === 'function') {
                        window.loadMoreHistory();
                    } else {
                        // Module not ready, try again in 100ms
                        setTimeout(executeLogic, 100);
                    }
                }
            };

            executeLogic();
        }
    };
</script>

</body>
</html>
