

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Command Console</title>
  
  <script type="module" src="../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=La+Belle+Aurore&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@200;300;400;600&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="../css/chat.css">
  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/reward.css">

  <link rel="stylesheet" href="../css/mobile.css">
  
</head>
<body>

<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
<input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green); font-family: 'Orbitron';">TASK<br>SUBMITTED</div>
    </div>
</div>

<svg style="display:none;">
    <symbol id="icon-coin" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.69 1.64 1.83 1.64 1.22 0 1.6-.64 1.6-1.26 0-.81-.42-1.22-2.34-1.67-2.37-.59-3.54-1.7-3.54-3.41 0-1.68 1.29-2.94 3.28-3.29V4h2.66v1.93c1.61.27 2.87 1.28 3.01 3.05h-1.95c-.14-.99-.68-1.55-1.7-1.55-1.04 0-1.55.56-1.55 1.15 0 .75.46 1.2 2.37 1.65 2.51.6 3.58 1.74 3.58 3.52 0 1.82-1.46 3.09-3.28 3.34z"/></symbol>
    <symbol id="icon-sparkles" viewBox="0 0 24 24"><path d="M9.5 1L8 4.5L4.5 6L8 7.5L9.5 11L11 7.5L14.5 6L11 4.5L9.5 1zm0 0"/><path d="M19 8.5L17.5 11L15 12.5L17.5 14L19 16.5L20.5 14L23 12.5L20.5 11L19 8.5zm0 0"/><path d="M16.5 18L15.5 20L13.5 21L15.5 22L16.5 24L17.5 22L19.5 21L17.5 20L16.5 18zm0 0"/></symbol>
</svg>

<div id="DESKTOP_APP">
  <div class="app-container">
    
   <div class="layout-left">
        <!-- HIERARCHY STAMP -->
        <div id="subHierarchy" class="hierarchy-top">LOADING...</div>

        <div class="avatar-container" onclick="document.getElementById('profileUploadInput').click()">
            <img id="profilePic" src="" alt="Avatar">
        </div>
        <div id="subName" class="identity-name">SLAVE</div>

        <!-- STATS ROW -->
        <div class="stats-stack-row">
            <div class="stat-item">
                <span class="stat-lbl">MERIT</span>
                <span id="points" class="stat-val">0</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <span class="stat-lbl">CAPITAL</span>
                <span id="coins" class="stat-val">0</span>
            </div>
        </div>

        <!-- KNEEL BUTTON -->
        <div class="kneel-sidebar-wrapper">
            <div id="btn" class="kneel-bar-graphic" 
                 onmousedown="handleHoldStart(event)" 
                 onmouseup="handleHoldEnd(event)" 
                 onmouseleave="handleHoldEnd(event)" 
                 ontouchstart="handleHoldStart(event)" 
                 ontouchend="handleHoldEnd(event)">
                <div id="fill" class="graphic-fill"></div>
                <span id="txt-main" class="graphic-text">HOLD TO KNEEL</span>
            </div>
        </div>

        <!-- EXPANDABLE STATS -->
        <button class="stats-toggle-btn" onclick="toggleStats()">EXPAND STATS ‚ñæ</button>
        
        <div id="statsContent" class="stats-panel">
            
            <!-- PROGRESS SECTION -->
            <div class="progress-section">
                <!-- Row: NEXT (Left) | RANK (Right) -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-family: 'Cinzel', serif; font-size: 0.7rem;">
                    <span style="color:#666;">NEXT:</span>
                    <span id="nextLevelName" style="color:var(--gold); font-weight:700;">-</span>
                </div>
                
                <!-- Bar -->
                <div class="prog-bg"><div id="progressBar" class="prog-fill"></div></div>
                
                <!-- Center: Points to go -->
                <div style="text-align: center; margin-top: 5px;">
                    <span id="pointsNeeded" style="color:#888; font-size:0.65rem; font-family:'Cinzel', serif;">0 to go</span>
                </div>
            </div>

            <!-- DETAILED STATS LIST -->
            <div class="stat-line"><span>Streak</span> <strong id="statStreak">0</strong></div>
            <div class="stat-line"><span>Total Tasks</span> <strong id="statTotal">0</strong></div>
            <div class="stat-line"><span>Completed</span> <strong id="statCompleted">0</strong></div>
            <div class="stat-line"><span>Skipped</span> <strong id="statSkipped">0</strong></div>
            <div class="stat-line"><span>Total Kneeling</span> <strong id="statTotalKneels">0</strong></div>
            
            <div class="stat-footer">
                <div style="color:#666; font-size:0.7rem; letter-spacing:2px; margin-bottom:5px;">SLAVE SINCE</div>
                <strong id="slaveSinceDate" style="color:#ccc; font-size:0.9rem;">--/--/--</strong>
            </div>

        </div> <!-- END OF STATS PANEL -->

        <!-- NAV MENU (NOW OUTSIDE AND SEPARATE) -->
        <div class="nav-menu">
            <button class="nav-btn active" onclick="switchTab('serve')">CONSOLE</button>
            <button class="nav-btn" onclick="switchTab('history')">SLAVE RECORD</button>
            <button class="nav-btn" onclick="switchTab('news')">QUEEN KARIN</button>
            <button class="nav-btn" onclick="switchTab('vault')">VAULT</button>
            <button class="nav-btn" onclick="switchTab('protocol')">PROTOCOL</button>
            <button class="nav-btn" onclick="switchTab('buy')">EXCHEQUER</button>
        </div>
        
    </div>

    <!-- RIGHT SIDE -->
    <div class="layout-right">

      <button id="mobileMenuBtn" onclick="toggleMobileMenu()" style="
        display: none; /* Hidden on desktop */
        position: absolute; 
        top: 15px; left: 15px; 
        z-index: 999; 
        background: black; 
        border: 1px solid var(--gold); 
        color: var(--gold); 
        font-size: 1.5rem; 
        padding: 5px 12px;
        font-family: sans-serif;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    ">‚ò∞</button>
    
    <!-- Header is empty/hidden to give room -->
    <div class="right-header hidden"></div>

    <div class="content-stage">
        
        <!-- 1. CONSOLE (Task & Chat) -->
        <div id="viewServingTop" class="view-wrapper" style="display: flex; flex-direction: column; height: 100%;">
            
          <!-- TASK CARD (FIXED SINGLE STATUS SOURCE) -->
            <div id="taskCard" class="glass-card task-ribbon" style="margin: 20px 20px 0 20px; position: relative; z-index: 100; justify-content: space-between;">
                
                <!-- LEFT: STATUS (Single Element) -->
                <div class="ribbon-left" style="width: 30%; border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div class="ribbon-label">CURRENT STATUS</div>
                    <!-- SINGLE ID for Status - JS changes text and color -->
                    <div id="mainStatusText" class="status-text-lg status-unproductive">UNPRODUCTIVE</div>
                </div>
                
                <!-- CENTER: DATA (Timer OR Trash Talk) -->
                <div class="ribbon-center" style="width: 40%; border: none; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    
                    <!-- IDLE MESSAGE -->
                    <div id="idleMessage" class="ribbon-status" style="opacity: 0.5; font-style: italic;">
                        "Awaiting Royal Decree..."
                    </div>
            
                    <!-- ACTIVE TIMER -->
                    <div id="activeTimerRow" class="hidden" style="display: flex; flex-direction: column; align-items: center;">
    
                    <div class="timer-box-wrapper">
                        <div id="timerH" class="t-box">00</div>
                        <div class="t-sep">:</div>
                        <div id="timerM" class="t-box">00</div>
                        <div class="t-sep">:</div>
                        <div id="timerS" class="t-box">00</div>
                    </div>
                   </div>
                </div>
            
                <!-- RIGHT: ACTION DECK -->
                <div class="ribbon-right" style="width: 30%; display: flex; justify-content: center; align-items: center;">
                    
                    <!-- REQUEST (Idle) -->
                    <div id="mainButtonsArea" style="width: 100%; padding: 0 10px;">
                        <button id="newTaskBtn" onclick="window.getRandomTask()" class="action-btn" style="width: 100%;">REQUEST TASK</button>
                    </div>
                    
                    <!-- ACTIONS (Active) -->
                    <div id="uploadBtnContainer" class="hidden" style="width: 100%; display: flex; gap: 10px; justify-content: center; align-items: center; padding: 0 10px;">
                        <!-- Ghost Button -->
                        <button onclick="window.toggleTaskDetails(null)" class="btn-ghost">SEE TASK</button>
                        <!-- Solid Button -->
                        <input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="window.handleUploadStart(this)">
                        <button id="btnUpload" onclick="document.getElementById('evidenceInput').click()" class="action-btn btn-upload">UPLOAD</button>
                    </div>
                </div>
            </div>
            <!-- DRAWER (Slides Down) -->
            <div id="taskDetailPanel" class="task-detail-panel">
                <div class="detail-content">
                    <div style="color: #666; font-size: 0.7rem; margin-bottom: 10px; font-family: 'Cinzel';">CURRENT ORDERS</div>
                    <h2 id="readyText" class="drawer-task-text">LOADING...</h2>
                    <div style="border-top: 1px solid #333; padding-top: 20px; width: 100%; display: flex; justify-content: center; gap: 20px;">
                        <button onclick="window.toggleTaskDetails(false)" class="text-btn">‚ñ≤ HIDE</button>
                        <button id="btnSkip" onclick="window.cancelPendingTask()" class="btn-skip-small">SKIP TASK</button>
                    </div>
                </div>
            </div>

            <!-- CHAT -->
            <div id="chatCard" class="chat-container" style="flex-grow: 1; overflow: hidden; margin-top: 20px;">
                <div id="chatBox" class="chat-body-frame">
                    
                    <!-- IN-CHAT OVERLAYS -->
                    <div id="kneelRewardOverlay" class="hidden overlay-center">
                        <div style="text-align: center;">
                            <h2 style="color:white; margin-bottom: 20px; font-family:'Orbitron';">DEVOTION RECOGNIZED</h2>
                            <div style="display:flex; gap:10px;">
                                <button onclick="claimKneelReward('coins')" class="action-btn">COINS</button>
                                <button onclick="claimKneelReward('points')" class="action-btn">POINTS</button>
                            </div>
                        </div>
                    </div>
                    <div id="chatMediaOverlay" class="hidden overlay-center">
                        <div id="mediaOverlayClose" onclick="closeChatPreview()" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;">X</div>
                        <div id="chatMediaOverlayContent"></div>
                    </div>
                    <div id="tributeHuntOverlay" class="hidden overlay-center" style="background:#000; padding:20px; flex-direction:column;">
                        <button onclick="toggleTributeHunt()" style="color: white; align-self:flex-end; font-family:'Orbitron'; background:none; border:none; cursor:pointer;">CLOSE</button>
                        <div id="huntStoreGrid" class="store-grid" style="margin-top: 20px;"></div>
                        <textarea id="huntNote" class="hidden"></textarea>
                        <div id="huntProgress" class="hidden"></div>
                    </div>

                    <div id="chatContent" class="chat-area"></div>
                </div>
                <div class="chat-footer">
                    <button id="tributeHuntBtn" onclick="toggleTributeHunt()" class="icon-btn">üéÅ</button>
                    <input type="text" id="chatMsgInput" class="chat-input" placeholder="AWAITING INPUT..." onkeypress="handleChatKey(event)">
                    <button class="chat-send" onclick="sendChatMessage()" class="icon-btn">Send</button>
                </div>
            </div>
        </div>

        <!-- 2. EXCHEQUER (RESTORED) -->
        <div id="viewBuy" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
            <div class="glass-card" style="margin-bottom: 20px;"><h2 style="text-align: center; color: var(--neon-yellow); font-family:'Cinzel';">EXCHEQUER</h2></div>
            <div class="store-grid">
                <div class="store-item"><div>1K</div><button class="si-btn" onclick="buyRealCoins(1000)">‚Ç¨10.00</button></div>
                <div class="store-item"><div>5.5K</div><button class="si-btn" onclick="buyRealCoins(5500)">‚Ç¨50.00</button></div>
                <div class="store-item"><div>12K</div><button class="si-btn" onclick="buyRealCoins(12000)">‚Ç¨100.00</button></div>
                <div class="store-item"><div>30K</div><button class="si-btn" onclick="buyRealCoins(30000)">‚Ç¨250.00</button></div>
                <div class="store-item"><div>70K</div><button class="si-btn" onclick="buyRealCoins(70000)">‚Ç¨500.00</button></div>
                <div class="store-item"><div>150K</div><button class="si-btn" onclick="buyRealCoins(150000)">‚Ç¨1000.00</button></div>
            </div>
        </div>

    <!-- 3. EVIDENCE LOG (THE TRILOGY) -->
         <div id="historySection" class="view-wrapper hidden" style="height: 100%; display: flex; flex-direction: column; overflow: hidden; background: #020202;">

          <!-- 1. TOP: THE ALTAR (Static Triptych) -->
          <div class="trilogy-section section-altar triptych-stage">
              <!-- Background Light -->
              <div class="altar-halo"></div>
      
              <!-- LEFT OFFERING (Rank #2) -->
              <div class="altar-card side-card left-offering" id="altarSlot2" style="display:none;">
                  <div class="gold-bar bar-top"></div>
                  <div class="inner-hairline"></div>
                  <img src="" class="altar-img" id="imgSlot2">
                  <div class="gold-bar bar-bottom"></div>
                  <div class="altar-plaque" id="scoreSlot2"></div>
              </div>
      
              <!-- RIGHT OFFERING (Rank #3) -->
              <div class="altar-card side-card right-offering" id="altarSlot3" style="display:none;">
                  <div class="gold-bar bar-top"></div>
                  <div class="inner-hairline"></div>
                  <img src="" class="altar-img" id="imgSlot3">
                  <div class="gold-bar bar-bottom"></div>
                  <div class="altar-plaque" id="scoreSlot3"></div>
              </div>
      
              <!-- CENTER IDOL (Rank #1) -->
              <div class="altar-card center-idol" id="altarSlot1" style="display:none;">
                  <div class="gold-bar bar-top"></div>
                  <div class="inner-hairline"></div>
                  <img src="" class="altar-img" id="imgSlot1">
                  <div class="gold-bar bar-bottom"></div>
                  <!-- Reflection -->
                  <div class="reflection-mask">
                      <img src="" class="reflect-img" id="reflectSlot1">
                  </div>
                  <!-- Score -->
                  <div class="altar-plaque main-plaque" id="scoreSlot1"></div>
              </div>
          </div>

    <!-- 2. MIDDLE: THE ARCHIVE -->
    <div class="trilogy-section section-archive">
        <div class="trilogy-label label-archive">PROCESSING</div>
        <div id="gridOkay" class="horizontal-scroll-track archive-track" style="display:flex; overflow-x:auto; height:100%; align-items:center; padding:0 20px;"></div>
    </div>

    <!-- 3. BOTTOM: THE HEAP -->
    <div class="trilogy-section section-heap">
        <div class="trilogy-label label-heap">CONTAINMENT</div>
        <div id="gridFailed" class="horizontal-scroll-track heap-track" style="display:flex; overflow-x:auto; height:100%; align-items:center; padding:0 20px;"></div>
    </div>

</div>

        <!-- 4. QUEEN KARIN NEWS (RESTORED) -->
        <div id="viewNews" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
            <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">QUEEN KARIN</h2></div>
            <div id="newsGrid" class="gallery-grid"></div>
        </div>

        <!-- 5. VAULT (RESTORED) -->
        <div id="viewVault" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
            <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">VAULT</h2></div>
            <div id="vaultGrid" class="gallery-grid"></div>
        </div>

        <!-- 6. PROTOCOL (RESTORED) -->
        <div id="viewProtocol" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
            <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">PROTOCOL</h2></div>
            <div style="color: #ccc; text-align: center; font-family:'Cinzel';">Obedience is the only currency.</div>
        </div>

        <div id="viewRewards" class="hidden"></div>
        <div id="viewHierarchy" class="hidden"></div>
        <div id="viewSession" class="hidden"></div>

        <!-- MODAL (RESTORED) -->
        <div id="glassModal" class="glass-modal">
          <div id="modalMediaContainer" class="modal-bg-photo"></div>
      
          <div id="modalGlassOverlay" class="modal-glass-overlay">
              
              <div id="modalCloseX" onclick="closeModal(null)" style="position:absolute; top:20px; right:20px; font-size:2rem; cursor:pointer; color:white; z-index:110;">√ó</div>
              
              <div class="theater-content dossier-layout">
                  
                  <div class="dossier-sidebar">
                      
                      <div class="dossier-block">
                          <div class="dossier-label">SYSTEM VERDICT</div>
                          <div class="stamp-container">
                              <img id="modalStatusSticker" src="" class="m-status-sticker-lg">
                          </div>
                      </div>
      
                      <div class="dossier-block">
                          <div class="dossier-label">MERIT ACQUIRED</div>
                          <div class="reward-container">
                              <div id="modalPoints" class="m-points-lg">+0</div>
                              <div id="modalSticker"></div>
                          </div>
                      </div>
      
                      <div id="modalFeedbackView" class="sub-view">
                          <div class="dossier-label">QUEEN'S FEEDBACK</div>
                          <div id="modalFeedbackText" class="theater-text-box"></div>
                      </div>
      
                      <div id="modalTaskView" class="sub-view hidden">
                          <div class="dossier-label">ORIGINAL ASSIGNMENT</div>
                          <div id="modalOrderText" class="theater-text-box"></div>
                      </div>
      
                  </div>
              </div>

      
      
              <div class="modal-footer-menu dossier-footer">
                  <button onclick="event.stopPropagation(); toggleHistoryView('feedback')" class="history-action-btn">FEEDBACK</button>
                  <button onclick="event.stopPropagation(); toggleHistoryView('task')" class="history-action-btn">THE TASK</button>
                  <button onclick="event.stopPropagation(); toggleHistoryView('proof')" class="history-action-btn gold-border">SEE PROOF</button>
                  <button onclick="event.stopPropagation(); toggleHistoryView('info')" class="history-action-btn">STATUS</button>
                  <button onclick="event.stopPropagation(); closeModal(null)" class="history-action-btn btn-close-red" style="grid-column: span 2;">CLOSE ARCHIVE</button>
              </div>
          </div>
      </div>
     </div>
         
    </div> 
    
</div>

  
<!-- üü¢ MOBILE UNIVERSE -->
<div id="MOBILE_APP" style="display:none;">
    
    <!-- 1. SCROLLABLE DASHBOARD -->
    <div id="viewMobileHome" class="mob-frame">
        
        <!-- HEADER -->
        <div class="mob-header">
            <div class="mob-hex-wrap">
                <img id="mob_profilePic" src="" class="mob-hex-img">
                <div id="mob_rankStamp" class="mob-rank-stamp">LOADING</div>
            </div>
            <div id="mob_slaveName" class="mob-name">SLAVE</div>
        </div>

        <!-- CARD 1: DEVOTION -->
        <div class="mob-card devotion-card">
            <div class="mob-kneel-zone" 
                 onmousedown="handleHoldStart(event)" 
                 onmouseup="handleHoldEnd(event)" 
                 onmouseleave="handleHoldEnd(event)" 
                 ontouchstart="handleHoldStart(event)" 
                 ontouchend="handleHoldEnd(event)">
                <div class="mob-kneel-inner">
                    <span class="kneel-icon">‚óà</span>
                    <span class="kneel-label">HOLD</span>
                </div>
                <div id="mob_kneelFill" class="mob-kneel-fill"></div>
            </div>

            <div class="mob-grid-zone">
                <div class="mob-grid-label">DAILY TRIBUTE</div>
                <div id="mob_streakGrid" class="mob-streak-grid"></div>
            </div>
        </div>

        <!-- CARD 2: OPERATIONS -->
        <div class="mob-card operations-card">
            <div class="op-status-row">
                <div id="mob_statusLight" class="status-light red"></div>
                <div id="mob_statusText" class="status-text">UNPRODUCTIVE</div>
            </div>
            
            <div class="op-action-row">
                <button id="mob_btnRequest" class="mob-action-btn" onclick="window.getRandomTask()">REQUEST PROTOCOL</button>
                <div id="mob_activeTimer" class="mob-timer hidden">
                    <span id="m_timerH">00</span>:<span id="m_timerM">00</span>:<span id="m_timerS">00</span>
                </div>
            </div>
        </div>

        <!-- SPACER (For Footer) -->
        <div style="height: 100px;"></div>

    </div> <!-- Closes viewMobileHome -->
</div> <!-- Closes MOBILE_APP -->

<!-- SWITCHER SCRIPT -->
<script>
    function checkDevice() {
        const isMobile = window.innerWidth <= 768;
        const desktop = document.getElementById('DESKTOP_APP');
        const mobile = document.getElementById('MOBILE_APP');
        
        if (isMobile) {
            if(desktop) desktop.style.display = 'none';
            if(mobile) mobile.style.display = 'flex';
        } else {
            if(mobile) mobile.style.display = 'none';
            if(desktop) desktop.style.display = 'flex'; 
        }
    }
    checkDevice();
    window.addEventListener('resize', checkDevice);
</script>
</body>
</html>
