
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Command Console</title>
  
  <script type="module" src="../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@200;300;400;600&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet" />

  <!-- DESKTOP STYLES -->
  <link rel="stylesheet" href="../css/chat.css">
  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/reward.css">

  <!-- MOBILE STYLES (INJECTED DIRECTLY TO PREVENT LOADING ERRORS) -->
  <style>
    /* Default: Mobile App is hidden */
    /* CRITICAL MOBILE STYLES */
    #MOBILE_APP { display: none; }

    @media screen and (max-width: 768px) {
        #MOBILE_APP {
            display: flex !important;
            flex-direction: column;
            width: 100vw;
            height: 100dvh;
            position: fixed;
            top: 0; left: 0;
            z-index: 999999;
            background: #000000;
            color: white;
            font-family: 'Cinzel', serif;
            overflow: hidden;
        }
        #DESKTOP_APP { display: none !important; }

        .mob-frame {
            flex: 1; overflow-y: auto; padding: 10px 5px; padding-bottom: 120px;
            display: flex; flex-direction: column; align-items: center; gap: 25px; width: 100%;
        }

      #mobRec_Grid, #mobRec_Heap {
    min-height: 100px; /* Ensures the container is visible even if empty */
}

      /* --- FIXED HEADER LAYOUT (ROYAL CARD) --- */

    /* 1. The Page Frame (Tight Edges) */
    .mob-frame {
        flex: 1;
        overflow-y: auto;
        padding: 10px 5px; /* Minimal padding */
        padding-bottom: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
    }

      /* --- HALO PROFILE LAYOUT --- */

    /* 1. ATMOSPHERE (The Blurred Background) */
    .mob-bg-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none;
    }
    .bg-blur {
        width: 100%; height: 100%; object-fit: cover;
        filter: blur(10px) brightness(0.4); /* Dark & Blurry */
        transform: scale(1.1); /* Prevents white edges from blur */
    }
    .bg-overlay {
        position: absolute; inset: 0;
        background: radial-gradient(circle at center, transparent 0%, #000 50%);
    }

    /* 2. THE HALO (Identity) */
    .halo-section {
        position: relative; z-index: 2;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        margin-top: 40px; margin-bottom: -30px; /* Overlap Pull */
    }

    .halo-ring {
        width: 280px; height: 280px;
        border-radius: 50%;
        border: 2px solid #c5a059; /* Gold */
        box-shadow: 0 0 30px rgba(197, 160, 89, 0.4), inset 0 0 20px rgba(197, 160, 89, 0.2);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: radial-gradient(circle, rgba(197,160,89,0.1) 0%, transparent 50%);
        backdrop-filter: blur(0px); /* Keeps text sharp */
    }

    .halo-name {
        font-family: 'Cinzel', serif; font-size: 2.2rem; color: #fff;
        text-transform: uppercase; letter-spacing: 2px;
        text-shadow: 0 0 20px rgba(255,255,255,0.4);
        line-height: 1; margin-bottom: 5px; text-align: center;
    }
    .halo-rank {
        font-family: 'Orbitron', sans-serif; font-size: 0.7rem; color: #c5a059;
        letter-spacing: 4px; text-transform: uppercase;
    }

    /* 3. THE STATS BRIDGE (Overlapping Card) */
    .halo-stats-card {
        position: relative; z-index: 3;
        margin-top: -40px;
        width: 100%;
        background: rgba(10, 10, 10, 0.85); /* Glass */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px;
        display: flex; align-items: center; justify-content: space-around;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        backdrop-filter: blur(15px);
        margin-bottom: 20px;
    }

    .h-stat { display: flex; flex-direction: column; align-items: center; }
    .h-val { font-family: 'Orbitron', serif; font-size: 1.5rem; color: #fff; line-height: 1; }
    .h-lbl { font-family: 'Orbitron', sans-serif; font-size: 0.5rem; color: #888; letter-spacing: 2px; margin-top: 4px; }
    .h-divider { width: 1px; height: 30px; background: rgba(255,255,255,0.15); }

    /* 4. CONTENT STACK */
    .halo-stack {
        position: relative; z-index: 3; width: 100%;
        display: flex; flex-direction: column; align-items: center; gap: 15px;
    }
    
   

    /* 2. The Main Card Container */
    .mob-profile-card {
        display: flex;
        flex-direction: column; /* Stack top row and bottom button */
        width: 100%; 
        background: rgba(10, 10, 10, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        padding: 15px 5px 5px 5px;
        box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
    }

    /* 3. Top Row (Face + Info) */
    .mob-card-top {
        display: flex;
        flex-direction: row;
        width: 100%;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
    }

    /* Left Column (Face) */
    .mob-visual-col {
        width: 30%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

  

    /* Rank Banner */
    .mob-rank-banner {
        margin-top: -12px;
        background: #000;
        color: grey; font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.6rem;
        padding: 5px 5px; border: 1px solid #fff; z-index: 10;
        box-shadow: 0 5px 10px rgba(0,0,0,0.8);
        text-transform: uppercase; white-space: nowrap;
    }

    /* Right Column (Data) */
    .mob-data-col {
        width: 70%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .mob-name-static {
        font-family: 'Cinzel', serif; font-size: 1.8rem; color: white;
        line-height: 1; text-transform: uppercase; text-shadow: 0 0 10px rgba(255,255,255,0.2);
    }

    .mob-stat-row { display: flex; align-items: center; gap: 15px; }
    .stat-pair { display: flex; flex-direction: column; align-items: center; }
    .stat-val { font-family: 'Cinzel', serif; font-size: 1.4rem; line-height: 1; }
    .stat-val.gray { color: #666; }
    .stat-val.gold-dim { color: #c5a059; opacity: 0.7; }
    .stat-lbl { font-family: 'Orbitron', sans-serif; font-size: 0.5rem; color: #666; letter-spacing: 2px; margin-top: 2px; }
    .stat-divider-vert { width: 1px; height: 25px; background: rgba(255,255,255,0.2); }

   /* 4. Bottom Button (Full Width Ghost) */
    .mob-stats-toggle-btn {
        width: 100%;
        background: transparent;
        border: 1px solid rgba(136, 136, 136, 0.3);
        color: #888;
        opacity: 0.7;
        font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.75rem;
        padding: 8px 0;
        cursor: pointer; letter-spacing: 2px;
        display: flex; align-items: center; justify-content: center; gap: 6px;
        border-radius: 4px;
        transition: 0.3s;
    }
    .mob-stats-toggle-btn:active { opacity: 1; border-color: #fff; color: #fff; }

    /* INTERNAL EXPANDING DRAWER (Replaces the old drawer) */
    .mob-internal-drawer {
        width: 100%;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: all 0.4s ease; /* Smooth expansion */
        
        /* Transparent because it lives inside the card now */
        background: transparent; 
        border-top: 1px solid transparent;
    }

    .mob-internal-drawer.open {
        max-height: 200px;
        opacity: 1;
        margin-top: 15px; /* Push away from button */
        padding-top: 5px;
        border-top: 1px solid rgba(255,255,255,0.1); /* Divider line */
    }
    
    .drawer-row { 
        display: flex; justify-content: space-between; 
        padding: 8px 0; 
        border-bottom: 1px solid rgba(255,255,255,0.05); 
    }
    .drawer-row:last-child { border-bottom: none; }

    .d-lbl { font-size: 0.7rem; color: #888; font-family: 'Cinzel'; letter-spacing: 1px; }
    .d-val { font-size: 0.8rem; color: #c5a059; font-family: 'Orbitron'; }
      
        /* 2. KNEEL BAR */
        .mob-section-wrapper { width: 80%; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .mob-kneel-bar {
            width: 100%; height: 50px;
            background: #080808; border: 1px solid #c5a059; border-radius: 4px;
            position: relative; overflow: hidden; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(197, 160, 89, 0.1);
            transition: 0.2s;
        }
        .mob-kneel-bar:active { border-color: #fff; transform: scale(0.98); }
        
        .mob-bar-fill {
            position: absolute; bottom: 0; left: 0; width: 0%; height: 100%; /* Fills Horizontal */
            background: linear-gradient(90deg, #8b0000, #000000); z-index: 1; transition: width 0.1s linear;
        }

        .mob-kneel-fill {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            height: 100%; /* Full Height */
            width: 0%;    /* Start Empty (Width) */
            background: linear-gradient(90deg, #8b0000, #000000); /* Left-to-Right Gradient */
            z-index: 1; 
            transition: width 0.1s linear; /* Allow JS to animate width */
        }
        .mob-bar-content { z-index: 2; display: flex; align-items: center; gap: 10px; }
        .kneel-icon-sm { color: #c5a059; font-size: 1.2rem; }
        .kneel-text { font-family: 'Orbitron'; font-family: 'Cinzel', serif; letter-spacing: 3px; color: #ccc; }
      

      /* 3. MICRO-TIMELINE (ELEGANT) */
        .mob-section-wrapper { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 2px; /* Tight gap between label and grid */
        }

        .mob-grid-label-center { 
            font-size: 0.5rem; 
            color: #444; /* Darker, subtler label */
            letter-spacing: 3px; 
            margin-bottom: 5px; 
            text-align: center; 
            width: 100%; 
        }

        .mob-streak-strip {
            display: grid; 
            grid-template-columns: repeat(12, 1fr); /* 12 Hours per row */
            gap: 3px; 
            width: 70%; /* RESTRICTED WIDTH */
            margin-bottom: 10px;
        }

        .streak-sq {
            height: 6px; /* Tiny, flat markers */
            background: rgba(255, 255, 255, 0.05); /* Faint grey when empty */
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1px;
        }

        /* ACTIVE STATE (Classy Gold) */
        .streak-sq.active {
            background: rgba(197, 160, 89, 0.6); /* 60% Opacity Gold */
            border-color: #c5a059;
            box-shadow: 0 0 8px rgba(197, 160, 89, 0.2); /* Very soft glow */
        }
        /* 4. TASK CARD */
        .operations-card {
            width: 100%; background:transparent; 
            border: 1px solid rgba(255, 255, 255, 0.1); border-top: 2px solid #333;
            border-radius: 8px; padding: 5px; margin-top: 10px;
        }
        .op-status-row { display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .status-light { width: 10px; height: 10px; border-radius: 50%; background: #333; }
        .status-light.red { background: #ff003c; box-shadow: 0 0 10px #ff003c; }
        .status-light.green { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .status-text { font-family: 'Orbitron', sans-serif; font-size: 1rem; color: #fff; letter-spacing: 2px; }

        .mob-action-btn {
            width: 100%; padding: 15px; background: transparent; margin-top: 15px;
            border: 1px solid #c5a059; color: #c5a059;
            font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.9rem;
            letter-spacing: 2px; cursor: pointer;
        }
       /* --- GOLD GAUGE TIMER --- */
        .mob-timer-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 5px;
            width: 100%;
        }

        .timer-gauge {
            position: relative;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0,0,0,0.5); /* Inner Dark Circle */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }

        

        .gauge-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
            z-index: 2;
        }

        .g-val {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.6rem;
            color: #fff;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .g-lbl {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.5rem;
            color: #c5a059;
            margin-top: -2px;
            letter-spacing: 1px;
        }

        @keyframes spinPulse {
            0% { transform: rotate(0deg); opacity: 0.8; }
            50% { opacity: 1; box-shadow: 0 0 10px rgba(197, 160, 89, 0.3); }
            100% { transform: rotate(360deg); opacity: 0.8; }
        }
      
        .hidden { display: none !important; }
    }

    /* MOBILE REWARD OVERLAY */
    .mob-reward-overlay {
        position: fixed; /* Floats over the dashboard */
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999; /* Below the footer, above the content */
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s ease;
    }

    .mob-reward-card {
        background: rgba(20, 20, 20, 0.95);
        border: 1px solid var(--mob-gold);
        padding: 40px 20px;
        border-radius: 4px;
        text-align: center;
        width: 85%;
        box-shadow: 0 0 30px rgba(197, 160, 89, 0.2);
        display: flex; flex-direction: column; align-items: center; gap: 20px;
    }

    .mob-reward-title {
        font-family: 'Cinzel', serif; color: white; 
        font-size: 0.8rem; letter-spacing: 2px;
        text-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .mob-reward-actions { width: 100%; display: flex; flex-direction: column; gap: 10px; }
    

    /* HORIZONTAL SCROLL CONTAINERS */
    .mob-horiz-scroll {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        gap: 10px;
        width: 100%;
        padding-right: 20px; /* Space at end */
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
    }
    .mob-horiz-scroll::-webkit-scrollbar { display: none; } /* Chrome */

    /* Normal Item (Archive) */
    .mob-scroll-item {
        flex: 0 0 120px; /* Fixed Width */
        height: 160px;
        position: relative;
        border: 1px solid #333;
        background: #111;
        border-radius: 4px;
        overflow: hidden;
    }

    /* Small Item (Heap) */
    .mob-horiz-scroll.small .mob-scroll-item {
        flex: 0 0 80px; /* Smaller */
        height: 80px;   /* Square */
        opacity: 0.6;
    }

    .mob-scroll-img { width: 100%; height: 100%; object-fit: cover; }
    
    /* Re-using Pending Badge */
    .mob-pending-badge {
        position: absolute; top: 5px; right: 5px;
        font-size: 1rem; text-shadow: 0 0 5px black;
    }

  /* --- 3D PYRAMID ALTAR (CSS FIX) --- */
    .mob-pyramid-stage {
        position: relative;
        width: 100%;
        height: 260px; /* Tall enough to fit the stack */
        margin-top: 15px;
        perspective: 1000px; /* Adds depth */
    }

    .mob-idol {
        position: absolute;
        background: #000;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .mob-idol img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        display: block; 
    }

    /* RANK 1: CENTER (The King) */
    .mob-idol.center {
        width: 160px; 
        height: 230px;
        top: 0;
        left: 50%;
        transform: translateX(-50%); /* Dead Center */
        z-index: 20; /* On Top */
        border: 2px solid #c5a059; /* Gold Border */
        box-shadow: 0 10px 40px rgba(0,0,0,0.9), 0 0 20px rgba(197, 160, 89, 0.2);
    }

    /* RANK 2: LEFT (The Servant) */
    .mob-idol.side {
        width: 130px; 
        height: 190px;
        top: 50px; /* Pushed down */
        left: 10%; /* Pushed Left */
        z-index: 5; /* Behind */
        border: 1px solid #444;
        filter: brightness(0.5) grayscale(50%); /* Dimmed */
        transform: rotate(-6deg); /* Tilted In */
    }

    /* RANK 3: RIGHT (The Servant) */
    .mob-idol.side.right {
        left: auto; 
        right: 10%; /* Pushed Right */
        transform: rotate(6deg); /* Tilted In */
    }
    
    /* Badges */
    .mob-rank-badge {
        position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
        background: #000; border: 1px solid #333; color: #888;
        font-family: 'Cinzel', serif; font-size: 0.6rem; padding: 2px 6px;
        z-index: 30;
    }
    .mob-rank-badge.main { 
        border-color: #c5a059; color: #c5a059; 
        bottom: 10px; /* Inside the card for the main one looks cleaner */
        background: rgba(0,0,0,0.8);
    }

    /* HIDE SCROLLBARS (BUT KEEP SCROLLING) */
    .mob-frame::-webkit-scrollbar, 
    .mob-horiz-scroll::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
    
    .mob-frame, .mob-horiz-scroll {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    /* HUD STYLES */
    .mob-hud-row {
        position: absolute; top: 15px; left: 0; width: 100%;
        display: flex; justify-content: space-between; padding: 0 20px;
        z-index: 10;
    }
    .hud-circle {
        width: 45px; height: 45px; border-radius: 50%;
        border: 1px solid rgba(255,255,255,0.2);
        background: #000; position: relative; overflow: visible;
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    .hud-circle img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; opacity: 0.8; }
    
    .hud-gear {
        position: absolute; bottom: -5px; right: -5px;
        font-size: 0.8rem; color: #fff; text-shadow: 0 0 5px #000;
    }
    .hud-status-dot {
        position: absolute; bottom: 0; right: 0;
        width: 10px; height: 10px; border-radius: 50%;
        border: 2px solid #000;
    }
    .hud-status-dot.online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
    .hud-status-dot.offline { background: #c5a059; box-shadow: 0 0 5px #c5a059; opacity: 0.5; }

    /* SETTINGS STYLES */
    .setting-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .setting-input {
        background: #111; border: 1px solid #333; color: white;
        padding: 8px; flex: 1; font-family: 'Rajdhani';
    }
    .setting-btn {
        background: #333; border: 1px solid #555; color: #fff;
        padding: 8px 12px; font-family: 'Orbitron'; font-size: 0.6rem; cursor: pointer;
    }
    .setting-btn.outline { background: transparent; }
    .setting-btn.gold { border-color: #c5a059; color: #c5a059; margin-bottom: 5px; width:100%; }
    .setting-label { font-size: 0.7rem; color: #888; margin-bottom: 5px; font-family:'Orbitron'; }

    /* LOBBY (SETTINGS) STYLES */
    /* SETTINGS WINDOW SCROLL FIX */
        .lobby-card {
            max-height: 75vh !important; /* Never taller than 75% of screen */
            overflow-y: auto !important; /* Allow scrolling INSIDE the card */
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iPhone */
            
            /* Hide Scrollbar */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .lobby-card::-webkit-scrollbar { 
            display: none; 
        }
        
     .lobby-header { margin-bottom: 25px; text-align: center; }
    .lobby-title { font-family: 'Cinzel', serif; font-size: 1.4rem; color: var(--mob-gold); letter-spacing: 4px; border-bottom: 1px solid #333; padding-bottom: 10px; display: inline-block;}
    .lobby-subtitle { font-family: 'Cinzel', serif; font-size: 0.6rem; color: #666; margin-top: 5px; letter-spacing: 2px; }

    .lobby-content { width: 100%; display: flex; flex-direction: column; gap: 12px; align-items: center; }

    /* ELEGANT BUTTONS */
    .lobby-btn {
        background: transparent;
        border: 1px solid #333;
        color: #ccc;
        font-family: 'Cinzel', serif;
        font-size: 0.8rem;
        padding: 12px;
        width: 100%;
        cursor: pointer;
        transition: 0.3s;
        letter-spacing: 2px;
    }
    .lobby-btn:active { background: rgba(255,255,255,0.05); border-color: #666; }
    .lobby-btn.gold { border-color: var(--mob-gold); color: var(--mob-gold); font-weight: 700; }
    .lobby-btn.close { border: none; color: #555; font-size: 0.7rem; margin-top: 5px; }
    .lobby-btn.small { font-size: 0.6rem; padding: 10px; }

    .lobby-divider { width: 50%; height: 1px; background: #222; margin: 5px 0; }

    /* ACTION VIEW */
    .lobby-prompt { font-family: 'Cinzel', serif; color: white; font-size: 1rem; text-align: center; margin-bottom: 15px; line-height: 1.4; }
    
    .lobby-input {
        background: #111; border: 1px solid #444; color: var(--mob-gold);
        font-family: 'Cinzel', serif; font-size: 1rem; padding: 10px;
        width: 100%; text-align: center; outline: none;
    }
    
    .lobby-file-btn {
        background: #111; border: 1px dashed #444; color: #888;
        padding: 20px; width: 100%; font-family: 'Cinzel'; cursor: pointer;
    }

    .lobby-cost-area { margin-top: 10px; margin-bottom: 5px; font-size: 0.7rem; color: #666; font-family: 'Orbitron'; letter-spacing: 1px; }
    .cost-val { color: var(--mob-gold); font-weight: bold; margin-left: 5px; }
    
    /* HUD PICS */
    .hud-circle img { object-fit: cover; }

   /* ROUTINE LIST (VERTICAL STACK) */
    .routine-grid {
        display: flex;
        flex-direction: column; /* Stack them */
        gap: 10px;
        width: 100%;
        margin-bottom: 15px;
    }
    
    .routine-tile {
        width: 100%;
        background: rgba(255, 255, 255, 0.03); /* Subtle glass */
        border: 1px solid #333;
        padding: 15px; /* Taller, clickable area */
        text-align: center;
        font-family: 'Cinzel', serif; /* Better font */
        font-size: 0.8rem;
        color: #888;
        cursor: pointer;
        transition: 0.2s;
        border-radius: 2px;
        letter-spacing: 2px;
    }

    .routine-tile:hover { 
        border-color: #666; 
        color: #fff; 
        background: rgba(255, 255, 255, 0.05);
    }
    
    /* Selected State (Solid Gold Border) */
    .routine-tile.selected {
        background: rgba(197, 160, 89, 0.1);
        border-color: #c5a059;
        color: #c5a059;
        font-weight: 700;
        box-shadow: inset 0 0 20px rgba(197, 160, 89, 0.1);
    }
    
    .routine-tile.special { 
        border-style: dashed; 
        color: #ccc;
    }

    /* EXCHEQUER (MOBILE STORE) */
    
    /* 1. The Coin Package Grid */
    .coin-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 Columns */
        gap: 10px;
        width: 100%;
        margin-top: 15px;
    }

    /* 2. The Coin Tile */
    .coin-tile {
        background: rgba(20, 20, 20, 0.9);
        border: 1px solid #333;
        border-radius: 4px;
        padding: 15px 5px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: 0.2s;
    }
    .coin-tile:active { background: rgba(197, 160, 89, 0.2); border-color: #c5a059; }

    .coin-amount { font-family: 'Rajdhani', sans-serif; font-size: 1.4rem; color: #c5a059; font-weight: 700; line-height: 1; }
    .coin-price { font-family: 'Cinzel', serif; font-size: 0.7rem; color: #888; }

    /* 3. The "Fill Wallet" Button styling */
    .wallet-btn {
        width: 100%; padding: 15px; background: transparent;
        border: 1px solid #c5a059; color: #c5a059;
        font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.9rem;
        letter-spacing: 2px; cursor: pointer;
        box-shadow: 0 0 15px rgba(197, 160, 89, 0.2);
    }

/* --- QUEEN MENU HEADER (Profile Style) --- */
.qm-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.qm-avatar {
    width: 50px; height: 50px;
    border-radius: 50%;
    border: 1px solid #c5a059;
    object-fit: cover;
    box-shadow: 0 0 10px rgba(197, 160, 89, 0.2);
}

.qm-info { display: flex; flex-direction: column; }
.qm-title { font-family: 'Cinzel', serif; font-size: 1.1rem; color: #fff; letter-spacing: 2px; }
.qm-date { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; color: #c5a059; letter-spacing: 1px; }

/* --- SECTIONS --- */
.duty-section {
    margin-bottom: 20px;
    width: 100%;
    display: flex; flex-direction: column; gap: 8px;
}

.duty-label {
    font-family: 'Cinzel', serif; 
    font-size: 0.9rem; 
    color: #888; 
    letter-spacing: 2px;
    border-bottom: 1px solid #222;
    padding-bottom: 5px;
    margin-bottom: 5px;
}

/* --- TEXT STATUSES (No Backgrounds) --- */
.txt-status-red { color: #ff003c; font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 1px; text-shadow: 0 0 5px rgba(255,0,60,0.4); }
.txt-status-green { color: #00ff00; font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 1px; text-shadow: 0 0 5px rgba(0,255,0,0.4); }
.txt-status-gold { color: #c5a059; font-family: 'Orbitron'; font-size: 0.8rem; letter-spacing: 1px; }

/* --- SMALL BUTTONS --- */
.btn-upload-sm {
    background: transparent; border: 1px solid #c5a059; color: #c5a059;
    font-family: 'Cinzel'; font-size: 0.65rem; padding: 6px 12px;
    cursor: pointer; align-self: flex-start;
}
.btn-upload-sm:active { background: rgba(197,160,89,0.2); }

.btn-skip-sm {
    background: transparent; border: 1px solid #444; color: #666;
    font-family: 'Cinzel'; font-size: 0.65rem; padding: 6px 12px;
    cursor: pointer;
}

/* --- REVERTED KNEELING STYLE --- */
.kneel-track-reverted {
    height: 10px; width: 100%; 
    background: #111; 
    border: 1px solid #333; 
    margin-top: 5px;
}
.kneel-fill-reverted {
    height: 100%; width: 0%; 
    background: #c5a059;
}
.kneel-fill-reverted.green { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
    
  </style>
</head>
<body>

<!-- SOUNDS & INPUTS -->
<audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="coinSound" src="/audio/2019-preview1.mp3"></audio>
<audio id="skipSound" src="https://static.wixstatic.com/mp3/ce3e5b_3b5b34d4083847e2b123b6fd9a8551fd.mp3"></audio>
<audio id="sfx-buy" src="/audio/2019-preview1.mp3"></audio>
<audio id="sfx-deny" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

<input type="file" id="profileUploadInput" accept="image/*" class="hidden" onchange="handleProfileUpload(this)">
<input type="file" id="adminMediaInput" accept="image/*,video/*" class="hidden" onchange="handleAdminUpload(this)">

<!-- CELEBRATION OVERLAY -->
<div id="celebrationOverlay" style="position:fixed;inset:0;pointer-events:none;z-index:2147483647;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s;">
    <div class="glass-card" style="border: 2px solid var(--neon-green); text-align:center;">
        <div style="font-size:1.8rem;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green); font-family: 'Orbitron';">TASK<br>SUBMITTED</div>
    </div>
</div>
<!-- =======================================================
     UNIVERSE A: DESKTOP APP (WRAPPED)
     ======================================================= -->
<div id="DESKTOP_APP">
  <div class="app-container">
    
   <div class="layout-left">
        <!-- HIERARCHY STAMP -->
        <div id="subHierarchy" class="hierarchy-top">LOADING...</div>

        <div class="avatar-container" onclick="document.getElementById('profileUploadInput').click()">
            <img id="profilePic" src="" alt="Avatar">
        </div>
        <div id="subName" class="identity-name">SLAVE</div>

        <!-- STATS ROW -->
        <div class="stats-stack-row">
            <div class="stat-item"><span class="stat-lbl">MERIT</span><span id="points" class="stat-val">0</span></div>
            <div class="stat-divider"></div>
            <div class="stat-item"><span class="stat-lbl">CAPITAL</span><span id="coins" class="stat-val">0</span></div>
        </div>

       <!-- KNEEL BUTTON (UPDATED) -->
        <div class="kneel-sidebar-wrapper">
            <div id="btn" class="kneel-bar-graphic" 
                 onmousedown="if(window.handleHoldStart) window.handleHoldStart(event)" 
                 onmouseup="if(window.handleHoldEnd) window.handleHoldEnd(event)" 
                 onmouseleave="if(window.handleHoldEnd) window.handleHoldEnd(event)" 
                 ontouchstart="if(window.handleHoldStart) window.handleHoldStart(event)" 
                 ontouchend="if(window.handleHoldEnd) window.handleHoldEnd(event)">
                <div id="fill" class="graphic-fill"></div>
                <span id="txt-main" class="graphic-text">HOLD TO KNEEL</span>
            </div>
        </div>

        <!-- EXPANDABLE STATS -->
        <button class="stats-toggle-btn" onclick="toggleStats()">EXPAND STATS ‚ñæ</button>
        <div id="statsContent" class="stats-panel">
            <div class="progress-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-family: 'Cinzel', serif; font-size: 0.7rem;">
                    <span style="color:#666;">NEXT:</span>
                    <span id="nextLevelName" style="color:var(--gold); font-weight:700;">-</span>
                </div>
                <div class="prog-bg"><div id="progressBar" class="prog-fill"></div></div>
                <div style="text-align: center; margin-top: 5px;">
                    <span id="pointsNeeded" style="color:#888; font-size:0.65rem; font-family:'Cinzel', serif;">0 to go</span>
                </div>
            </div>
            <div class="stat-line"><span>Streak</span> <strong id="statStreak">0</strong></div>
            <div class="stat-line"><span>Total Tasks</span> <strong id="statTotal">0</strong></div>
            <div class="stat-line"><span>Completed</span> <strong id="statCompleted">0</strong></div>
            <div class="stat-line"><span>Skipped</span> <strong id="statSkipped">0</strong></div>
            <div class="stat-line"><span>Total Kneeling</span> <strong id="statTotalKneels">0</strong></div>
            <div class="stat-footer">
                <div style="color:#666; font-size:0.7rem; letter-spacing:2px; margin-bottom:5px;">SLAVE SINCE</div>
                <strong id="slaveSinceDate" style="color:#ccc; font-size:0.9rem;">--/--/--</strong>
            </div>
        </div>

        <!-- NAV MENU -->
        <div class="nav-menu">
            <button class="nav-btn active" onclick="switchTab('serve')">CONSOLE</button>
            <button class="nav-btn" onclick="switchTab('record')">SLAVE RECORD</button>
            <button class="nav-btn" onclick="switchTab('news')">QUEEN KARIN</button>
            <button class="nav-btn" onclick="switchTab('vault')">VAULT</button>
            <button class="nav-btn" onclick="switchTab('protocol')">PROTOCOL</button>
            <button class="nav-btn" onclick="switchTab('buy')">EXCHEQUER</button>
        </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="layout-right">
        <!-- Header empty -->
        <div class="right-header hidden"></div>

        <div class="content-stage">
            <!-- 1. CONSOLE -->
            <div id="viewServingTop" class="view-wrapper" style="display: flex; flex-direction: column; height: 100%;">
                
                <!-- TASK CARD -->
                <div id="taskCard" class="glass-card task-ribbon" style="margin: 20px 20px 0 20px; position: relative; z-index: 100; justify-content: space-between;">
                    <div class="ribbon-left" style="width: 30%; border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div class="ribbon-label">CURRENT STATUS</div>
                        <div id="mainStatusText" class="status-text-lg status-unproductive">UNPRODUCTIVE</div>
                    </div>
                    <div class="ribbon-center" style="width: 40%; border: none; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div id="idleMessage" class="ribbon-status" style="opacity: 0.5; font-style: italic;">"Awaiting Royal Decree..."</div>
                        <div id="activeTimerRow" class="hidden" style="display: flex; flex-direction: column; align-items: center;">
                            <div class="timer-box-wrapper">
                                <div id="timerH" class="t-box">00</div><div class="t-sep">:</div>
                                <div id="timerM" class="t-box">00</div><div class="t-sep">:</div>
                                <div id="timerS" class="t-box">00</div>
                            </div>
                        </div>
                    </div>
                    <div class="ribbon-right" style="width: 30%; display: flex; justify-content: center; align-items: center;">
                        <div id="mainButtonsArea" style="width: 100%; padding: 0 10px;">
                            <button id="newTaskBtn" onclick="window.getRandomTask()" class="action-btn" style="width: 100%;">REQUEST TASK</button>
                        </div>
                        <div id="uploadBtnContainer" class="hidden" style="width: 100%; display: flex; gap: 10px; justify-content: center; align-items: center; padding: 0 10px;">
                            <button onclick="window.toggleTaskDetails(null)" class="btn-ghost">SEE TASK</button>
                            <input type="file" id="evidenceInput" accept="image/*,video/*" class="hidden" onchange="window.handleUploadStart(this)">
                            <button id="btnUpload" onclick="document.getElementById('evidenceInput').click()" class="action-btn btn-upload">UPLOAD</button>
                        </div>
                    </div>
                </div>

                <!-- DRAWER -->
                <div id="taskDetailPanel" class="task-detail-panel">
                    <div class="detail-content">
                        <div style="color: #666; font-size: 0.7rem; margin-bottom: 10px; font-family: 'Cinzel';">CURRENT ORDERS</div>
                        <h2 id="readyText" class="drawer-task-text">LOADING...</h2>
                        <div style="border-top: 1px solid #333; padding-top: 20px; width: 100%; display: flex; justify-content: center; gap: 20px;">
                            <button onclick="window.toggleTaskDetails(false)" class="text-btn">‚ñ≤ HIDE</button>
                            <button id="btnSkip" onclick="window.cancelPendingTask()" class="btn-skip-small">SKIP TASK</button>
                        </div>
                    </div>
                </div>

                <!-- CHAT -->
                <div id="chatCard" class="chat-container" style="flex-grow: 1; overflow: hidden; margin-top: 20px;">
                  
            <!-- MOBILE CHAT HEADER -->
                    <div class="mob-chat-header">
                        <!-- Back Button -->
                        <button class="chat-back" onclick="window.toggleMobileView('home')">‚Äπ</button>
                        
                        <!-- Queen Profile -->
                        <div class="chat-queen-profile">
                            <div class="queen-av-wrap">
                                <img src="https://static.wixstatic.com/media/ce3e5b_e06c7a2254d848a480eb98107c35e246~mv2.png" class="queen-av-img">
                                <!-- Online Dot -->
                                <div id="mobChatOnlineDot" class="status-dot"></div>
                            </div>
                            <div class="chat-meta-col">
                                <div class="chat-queen-name">QUEEN KARIN</div>
                                <!-- Live Status Text -->
                                <div id="mobChatStatusText" class="chat-status-text">CONNECTING...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chatBox" class="chat-body-frame">
                        <div id="kneelRewardOverlay" class="hidden overlay-center">
                            <div style="text-align: center;">
                                <h2 style="color:white; margin-bottom: 20px; font-family:'Orbitron';">DEVOTION RECOGNIZED</h2>
                                <div style="display:flex; gap:10px;">
                                    <button onclick="claimKneelReward('coins')" class="action-btn">COINS</button>
                                    <button onclick="claimKneelReward('points')" class="action-btn">POINTS</button>
                                </div>
                            </div>
                        </div>
                        <div id="chatMediaOverlay" class="hidden overlay-center">
                            <div id="mediaOverlayClose" onclick="closeChatPreview()" style="position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; cursor: pointer;">X</div>
                            <div id="chatMediaOverlayContent"></div>
                        </div>
                        <div id="tributeHuntOverlay" class="hidden overlay-center" style="background:#000; padding:20px; flex-direction:column;">
                            <button onclick="toggleTributeHunt()" style="color: white; align-self:flex-end; font-family:'Orbitron'; background:none; border:none; cursor:pointer;">CLOSE</button>
                            <div id="huntStoreGrid" class="store-grid" style="margin-top: 20px;"></div>
                            <textarea id="huntNote" class="hidden"></textarea>
                            <div id="huntProgress" class="hidden"></div>
                        </div>
                        <div id="chatContent" class="chat-area"></div>
                    </div>
                    <div class="chat-footer">
                        <button id="tributeHuntBtn" onclick="toggleTributeHunt()" class="icon-btn">üéÅ</button>
                        <input type="text" id="chatMsgInput" class="chat-input" placeholder="Whisper to Queen Karin..." onkeypress="handleChatKey(event)">
                        <button class="chat-send" onclick="sendChatMessage()" class="icon-btn">Send</button>
                    </div>
                </div>
            </div>
          

            <!-- OTHER VIEWS (EXCHEQUER, NEWS, VAULT, ETC) -->
            <div id="viewBuy" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px;"><h2 style="text-align: center; color: var(--neon-yellow); font-family:'Cinzel';">EXCHEQUER</h2></div>
                <div class="store-grid">
                    <div class="store-item"><div>1K</div><button class="si-btn" onclick="buyRealCoins(1000)">‚Ç¨10.00</button></div>
                    <div class="store-item"><div>5.5K</div><button class="si-btn" onclick="buyRealCoins(5500)">‚Ç¨50.00</button></div>
                    <div class="store-item"><div>12K</div><button class="si-btn" onclick="buyRealCoins(12000)">‚Ç¨100.00</button></div>
                    <div class="store-item"><div>30K</div><button class="si-btn" onclick="buyRealCoins(30000)">‚Ç¨250.00</button></div>
                    <div class="store-item"><div>70K</div><button class="si-btn" onclick="buyRealCoins(70000)">‚Ç¨500.00</button></div>
                    <div class="store-item"><div>150K</div><button class="si-btn" onclick="buyRealCoins(150000)">‚Ç¨1000.00</button></div>
                </div>
            </div>

            <!-- HISTORY SECTION -->
            <div id="historySection" class="view-wrapper hidden" style="height: 100%; display: flex; flex-direction: column; overflow: hidden; background: #020202;">
                <!-- ALTAR -->
                <div class="trilogy-section section-altar triptych-stage">
                    <div class="altar-halo"></div>
                    <div class="altar-card side-card left-offering" id="altarSlot2" style="display:none;">
                        <div class="gold-bar bar-top"></div><div class="inner-hairline"></div><img src="" class="altar-img" id="imgSlot2"><div class="gold-bar bar-bottom"></div><div class="altar-plaque" id="scoreSlot2"></div>
                    </div>
                    <div class="altar-card side-card right-offering" id="altarSlot3" style="display:none;">
                        <div class="gold-bar bar-top"></div><div class="inner-hairline"></div><img src="" class="altar-img" id="imgSlot3"><div class="gold-bar bar-bottom"></div><div class="altar-plaque" id="scoreSlot3"></div>
                    </div>
                    <div class="altar-card center-idol" id="altarSlot1" style="display:none;">
                        <div class="gold-bar bar-top"></div><div class="inner-hairline"></div><img src="" class="altar-img" id="imgSlot1"><div class="gold-bar bar-bottom"></div>
                        <div class="reflection-mask"><img src="" class="reflect-img" id="reflectSlot1"></div><div class="altar-plaque main-plaque" id="scoreSlot1"></div>
                    </div>
                </div>
                <!-- ARCHIVE -->
                <div class="trilogy-section section-archive">
                    <div class="trilogy-label label-archive">PROCESSING</div>
                    <div id="gridOkay" class="horizontal-scroll-track archive-track" style="display:flex; overflow-x:auto; height:100%; align-items:center; padding:0 20px;"></div>
                </div>
                <!-- HEAP -->
                <div class="trilogy-section section-heap">
                    <div class="trilogy-label label-heap">CONTAINMENT</div>
                    <div id="gridFailed" class="horizontal-scroll-track heap-track" style="display:flex; overflow-x:auto; height:100%; align-items:center; padding:0 20px;"></div>
                </div>
            </div>

            <!-- NEWS, VAULT, PROTOCOL -->
            <div id="viewNews" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">QUEEN KARIN</h2></div>
                <div id="newsGrid" class="gallery-grid"></div>
            </div>
            <div id="viewVault" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">VAULT</h2></div>
                <div id="vaultGrid" class="gallery-grid"></div>
            </div>
            <div id="viewProtocol" class="view-wrapper hidden" style="padding: 20px; overflow-y: auto;">
                <div class="glass-card" style="margin-bottom: 20px; text-align: center;"><h2 style="font-family:'Cinzel';">PROTOCOL</h2></div>
                <div style="color: #ccc; text-align: center; font-family:'Cinzel';">Obedience is the only currency.</div>
            </div>

            <div id="viewRewards" class="hidden"></div>
            <div id="viewHierarchy" class="hidden"></div>
            <div id="viewSession" class="hidden"></div>

            <!-- MODAL -->
            <div id="glassModal" class="glass-modal">
                <div id="modalMediaContainer" class="modal-bg-photo"></div>
                <div id="modalGlassOverlay" class="modal-glass-overlay">
                    <div id="modalCloseX" onclick="closeModal(null)" style="position:absolute; top:20px; right:20px; font-size:2rem; cursor:pointer; color:white; z-index:110;">√ó</div>
                    <div class="theater-content dossier-layout">
                        <div class="dossier-sidebar">
                            <div class="dossier-block">
                                <div class="dossier-label">SYSTEM VERDICT</div>
                                <div class="stamp-container"><img id="modalStatusSticker" src="" class="m-status-sticker-lg"></div>
                            </div>
                            <div class="dossier-block">
                                <div class="dossier-label">MERIT ACQUIRED</div>
                                <div class="reward-container"><div id="modalPoints" class="m-points-lg">+0</div><div id="modalSticker"></div></div>
                            </div>
                            <div id="modalFeedbackView" class="sub-view">
                                <div class="dossier-label">QUEEN'S FEEDBACK</div>
                                <div id="modalFeedbackText" class="theater-text-box"></div>
                            </div>
                            <div id="modalTaskView" class="sub-view hidden">
                                <div class="dossier-label">ORIGINAL ASSIGNMENT</div>
                                <div id="modalOrderText" class="theater-text-box"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer-menu dossier-footer">
                        <button onclick="event.stopPropagation(); toggleHistoryView('feedback')" class="history-action-btn">FEEDBACK</button>
                        <button onclick="event.stopPropagation(); toggleHistoryView('task')" class="history-action-btn">THE TASK</button>
                        <button onclick="event.stopPropagation(); toggleHistoryView('proof')" class="history-action-btn gold-border">SEE PROOF</button>
                        <button onclick="event.stopPropagation(); toggleHistoryView('info')" class="history-action-btn">STATUS</button>
                        <button onclick="event.stopPropagation(); closeModal(null)" class="history-action-btn btn-close-red" style="grid-column: span 2;">CLOSE ARCHIVE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div> <!-- END DESKTOP_APP -->

<!-- üü¢ MOBILE UNIVERSE (HALO + WORKING TIMER + RECORD) -->
<div id="MOBILE_APP" style="display:none;">
    
    <!-- 1. DASHBOARD (HOME) -->
    <div id="viewMobileHome" class="mob-frame">
        
        <!-- DYNAMIC BACKGROUND -->
        <div class="mob-bg-layer">
            <img id="mob_bgPic" src="https://static.wixstatic.com/media/ce3e5b_e06c7a2254d848a480eb98107c35e246~mv2.png" class="bg-blur">
            <div class="bg-overlay"></div>
        </div>

         <!-- HUD -->
        <div class="mob-hud-row">
            <div class="hud-circle slave" onclick="openLobby()">
                <img id="hudSlavePic" src="">
                <div class="hud-gear">‚öô</div>
            </div>
             <div class="hud-circle queen" onclick="openQueenMenu()">
                <img src="https://static.wixstatic.com/media/ce3e5b_e06c7a2254d848a480eb98107c35e246~mv2.png">
                <div id="hudDomStatus" class="hud-status-dot offline"></div>
            </div>
        </div>

        <!-- SETTINGS MENU (LOBBY) -->
        <div id="lobbyOverlay" class="mob-reward-overlay hidden">
            <div class="mob-reward-card lobby-card">
                <!-- VIEW 1: MENU LIST -->
                <div id="lobbyMenu" class="lobby-content">
                    <button class="lobby-btn" onclick="showLobbyAction('name')">ADD YOUR NAME</button>
                    <button class="lobby-btn" onclick="showLobbyAction('photo')">UPLOAD PHOTO</button>
                    <button class="lobby-btn" onclick="showLobbyAction('routine')">GET ROUTINE</button>
                    <button class="lobby-btn" onclick="showLobbyAction('kinks')">ADD KINKS</button>
                    <button class="lobby-btn" onclick="showLobbyAction('limits')">ADD LIMITS</button>
                    <div class="lobby-divider"></div>
                    <button class="lobby-btn close" onclick="closeLobby()">CLOSE</button>
                </div>

                <!-- VIEW 2: ACTION INPUT -->
                <div id="lobbyActionView" class="lobby-content hidden">
                    <div id="lobbyPrompt" class="lobby-prompt">...</div>
                    <input type="text" id="lobbyInputText" class="lobby-input hidden" placeholder="Type here...">
                    <button id="lobbyInputFileBtn" class="lobby-file-btn hidden" onclick="document.getElementById('lobbyFile').click()">PICK PHOTO</button>
                    <input type="file" id="lobbyFile" hidden onchange="document.getElementById('lobbyInputFileBtn').innerText = 'PHOTO UPLOADED'">

                    <div id="routineSelectionArea" class="hidden" style="width:100%; display:flex; flex-direction:column; gap:10px;">
                        <div class="lobby-label" style="font-size:0.6rem; color:#888;">SELECT PROTOCOL:</div>
                        <div class="routine-grid">
                            <div class="routine-tile" onclick="selectRoutineItem(this, 'Morning Kneel')">Morning Kneel</div>
                            <div class="routine-tile" onclick="selectRoutineItem(this, 'Chastity Check')">Chastity Check</div>
                            <div class="routine-tile" onclick="selectRoutineItem(this, 'Cleanliness Check')">Cleanliness Check</div>
                            <div class="routine-tile special" onclick="selectRoutineItem(this, 'custom')">CREATE OWN (+1000)</div>
                        </div>
                        <input type="text" id="routineCustomInput" class="lobby-input hidden" placeholder="Describe your routine..." style="margin-top:10px;">
                    </div>

                    <div id="kinkSelectionArea" class="hidden" style="width:100%; display:flex; flex-direction:column; gap:10px;">
                         <div class="lobby-label" style="font-size:0.6rem; color:#888;">SELECT INTERESTS (100 EACH):</div>
                         <div id="kinkGrid" class="routine-grid"></div>
                    </div>

                    <div class="lobby-cost-area">
                        <span class="cost-lbl">COST:</span>
                        <span id="lobbyCostDisplay" class="cost-val">0</span>
                    </div>

                    <button id="btnLobbyConfirm" class="lobby-btn gold" onclick="confirmLobbyAction()">SUBMIT</button>
                    <button class="lobby-btn close" onclick="backToLobbyMenu()">BACK</button>
                </div>
            </div>
        </div>

        <!-- QUEEN'S DUTY MENU (DAILY CARD) -->
        <!-- QUEEN'S DUTY MENU -->
<div id="queenOverlay" class="mob-reward-overlay hidden">
    <div class="mob-reward-card lobby-card">
        
        <!-- 1. HEADER (CENTERED PROFILE) -->
        <div class="qm-header">
            <img src="https://static.wixstatic.com/media/ce3e5b_e06c7a2254d848a480eb98107c35e246~mv2.png" class="qm-avatar">
            <div class="qm-info">
                <div class="qm-title">DAILY DUTIES</div>
                <div class="qm-date" id="dutyDateDisplay">--/--/--</div>
            </div>
        </div>

        <div class="lobby-content" style="width:100%; align-items:flex-start; padding: 0 10px;">

            <!-- SECTION 1: PROTOCOL -->
            <div class="duty-section">
                <div class="duty-label">PROTOCOL</div>
                
                <!-- Routine Name -->
                <div id="mobRoutineDisplay" style="font-family:'Cinzel'; font-size:1rem; color:#fff; margin-bottom:5px;">
                    LOADING...
                </div>

                <!-- 7AM / Status Text -->
                <div id="routineTimeMsg" class="txt-status-gold hidden">LOCKED UNTIL 07:00</div>
                <div id="routineDoneMsg" class="txt-status-green hidden">‚úî EVIDENCE SUBMITTED</div>

                <!-- Small Upload Button -->
                <button id="btnRoutineUpload" class="btn-upload-sm hidden" onclick="document.getElementById('routineUpload').click()">
                    UPLOAD EVIDENCE
                </button>
                <input type="file" id="routineUpload" hidden onchange="window.handleRoutineUpload(this)">
            </div>

            <div class="lobby-divider" style="width:100%;"></div>

            <!-- SECTION 2: LABOR -->
            <div class="duty-section" style="margin-top:10px;">
                <div class="duty-label">LABOR</div>

                <!-- STATE: IDLE -->
                <div id="qm_TaskIdle" class="hidden">
                    <div class="txt-status-red" style="margin-bottom:10px;">UNPRODUCTIVE</div>
                    <!-- Standard Request Button -->
                    <button class="lobby-btn" onclick="window.getRandomTask()">REQUEST TASK</button>
                </div>

                <!-- STATE: ACTIVE -->
                <div id="qm_TaskActive" class="hidden">
                    <div class="txt-status-green" style="margin-bottom:5px;">WORKING</div>
                    
                    <!-- Timer -->
                    <div class="card-timer-row">
                        <div id="qm_timerH" class="card-t-box">00</div>:
                        <div id="qm_timerM" class="card-t-box">00</div>:
                        <div id="qm_timerS" class="card-t-box">00</div>
                    </div>

                    <!-- Actions -->
                    <div style="display:flex; gap:10px;">
                        <button class="btn-upload-sm" onclick="document.getElementById('evidenceInput').click()">UPLOAD EVIDENCE</button>
                        <button class="btn-skip-sm" onclick="window.cancelPendingTask()">SKIP</button>
                    </div>
                </div>
            </div>

            <div class="lobby-divider" style="width:100%;"></div>

            <!-- SECTION 3: KNEELING (REVERTED STYLE) -->
            <div class="duty-wrapper" style="width:100%; margin-top:10px;">
                <div class="lobby-label">KNEELING GOAL (8/DAY)</div>
                <div class="kneel-track-reverted">
                    <div id="kneelDailyFill" class="kneel-fill-reverted"></div>
                </div>
                <div id="kneelDailyText" style="text-align:center; font-family:'Orbitron'; font-size:0.7rem; color:#fff; margin-top:5px;">0 / 8</div>
            </div>

            <button class="lobby-btn close" style="margin-top:30px;" onclick="closeQueenMenu()">CLOSE CARD</button>
        </div>
    </div>
</div>

        <!-- 2. THE HALO (Identity) -->
        <div class="halo-section">
            <div class="halo-ring">
                <div id="mob_slaveName" class="halo-name">SLAVE</div>
                <div id="mob_rankStamp" class="halo-rank">INITIATE</div>
                <div class="mob-section-wrapper" style="width:100%;">
                <div class="mob-grid-label-center">DAILY PROGRESS</div>
                <div id="mob_streakGrid" class="mob-streak-strip"></div>
            </div>
         </div>

        <!-- 3. STATS BRIDGE & DRAWER -->
        <div style="width:100%; display:flex; flex-direction:column; align-items:center; z-index:3;">
            <div class="halo-stats-card">
                <div class="h-stat"><span class="h-val" id="mobPoints">0</span><span class="h-lbl">MERIT</span></div>
                <div class="h-divider"></div>
                <div class="h-stat"><span class="h-val" id="mobCoins">0</span><span class="h-lbl">NET</span></div>
            </div>

            <div class="mob-stats-toggle-btn" onclick="toggleMobileStats()">
                SLAVE STATS <span id="mobStatsArrow">‚ñº</span>
            </div>

            <div id="mobStatsContent" class="mob-internal-drawer">
                <div class="drawer-row"><span class="d-lbl">CURRENT STREAK</span><span class="d-val" id="mobStreak">0</span></div>
                <div class="drawer-row"><span class="d-lbl">TOTAL SERVED</span><span class="d-val" id="mobTotal">0</span></div>
                <div class="drawer-row"><span class="d-lbl">KNEEL COUNT</span><span class="d-val" id="mobKneels">0</span></div>
            </div>
        </div>

        <!-- 4. ACTION STACK -->
        <div class="halo-stack" style="padding: 0 20px; width:100%; margin-top:15px;">
            <div class="mob-kneel-bar mob-kneel-zone" 
                 onmousedown="if(window.handleHoldStart) window.handleHoldStart(event)" 
                 onmouseup="if(window.handleHoldEnd) window.handleHoldEnd(event)" 
                 onmouseleave="if(window.handleHoldEnd) window.handleHoldEnd(event)" 
                 ontouchstart="if(window.handleHoldStart) window.handleHoldStart(event)" 
                 ontouchend="if(window.handleHoldEnd) window.handleHoldEnd(event)">
                <div id="mob_kneelFill" class="mob-bar-fill"></div>
                <div class="mob-bar-content">
                    <span class="kneel-icon-sm">‚óà</span>
                    <span id="mob_kneelText" class="kneel-text kneel-label">HOLD TO KNEEL</span>
                </div>
            </div>
         </div>

        <!-- REWARD POPUP -->
        <div id="mobKneelReward" class="mob-reward-overlay hidden">
            <div class="mob-reward-card">
                <div class="mob-hex-wrap small-reward">
                    <div class="mob-rank-stamp" style="right: auto; left: -5px; color: #fff; border-color: #fff;">AUTHORIZED</div>
                </div>
                <h2 class="mob-reward-title">DEVOTION RECOGNIZED</h2>
                <div class="mob-reward-actions">
                    <button onclick="window.claimKneelReward('coins')" class="mob-action-btn" style="border-color: #ffd700; color: #ffd700;">CLAIM COINS</button>
                    <button onclick="window.claimKneelReward('points')" class="mob-action-btn" style="border-color: #fff; color: #fff;">CLAIM MERIT</button>
                </div>
            </div>
        </div>
        <div style="height: 120px;"></div>
    </div>
    </div> <!-- END HOME -->

    <!-- 2. MOBILE RECORD (THE VERTICAL VAULT) -->
    <div id="viewMobileRecord" class="mob-frame" style="display:none; flex-direction:column; padding-left:0; padding-right:0; padding-top:10px;">
        <!-- HEADER -->
        <div class="mob-header" style="margin-bottom:10px;">
            <div class="mob-name">SLAVE RECORD</div>
        </div>
        <!-- ALTAR -->
        <div class="mob-altar-container">
            <div class="mob-grid-label-center">HIGHEST MERIT</div>
            <div class="mob-pyramid-stage">
                <div class="mob-idol side"><img id="mobRec_Slot2" src=""><div class="mob-rank-badge">II</div></div>
                <div class="mob-idol side right"><img id="mobRec_Slot3" src=""><div class="mob-rank-badge">III</div></div>
                <div class="mob-idol center"><img id="mobRec_Slot1" src=""><div class="mob-rank-badge main">I</div></div>
            </div>
        </div>
        <!-- ARCHIVE -->
        <div class="mob-section-wrapper" style="margin-top:20px; align-items:flex-start; padding-left:20px;">
            <div class="mob-grid-label">ACCEPTED PROTOCOLS</div>
            <div id="mobRec_Grid" class="mob-horiz-scroll"></div>
        </div>
        <!-- HEAP -->
        <div class="mob-section-wrapper" style="margin-top:20px; align-items:flex-start; padding-left:20px;">
            <div class="mob-grid-label" style="color:#ff003c;">DENIED / FAILED</div>
            <div id="mobRec_Heap" class="mob-horiz-scroll small"></div>
        </div>
        <div style="height: 120px;"></div>
    </div>

   <!-- 5. GLOBAL VIEW -->
    <div id="viewMobileGlobal" class="mob-frame" style="display:none; flex-direction:column;">
        <!-- HEADER -->
        <div class="mob-header">
            <div class="mob-name" style="margin-top:20px;">GLOBAL NETWORK</div>
        </div>

        <!-- FILL WALLET BUTTON -->
        <div class="mob-section-wrapper" style="width:90%; margin-bottom:20px;">
            <button class="wallet-btn" onclick="openExchequer()">FILL WALLET</button>
        </div>

        <!-- PROTOCOL TEXT -->
        <div class="mob-card" style="width:90%; text-align:center;">
            <div class="status-text" style="color:#888; font-size:0.7rem; margin-bottom:10px;">PROTOCOL STATUS</div>
            <div style="font-family:'Cinzel'; font-size:1.2rem; color:#fff;">OBEDIENCE IS MANDATORY</div>
            <div style="font-family:'Orbitron'; font-size:0.6rem; color:#666; margin-top:10px;">SERVER: ONLINE</div>
        </div>
        
        <!-- EXCHEQUER OVERLAY (Hidden Store) -->
        <div id="mobExchequer" class="mob-reward-overlay hidden">
            <div class="mob-reward-card lobby-card">
                <div class="lobby-header">
                    <div class="lobby-title">EXCHEQUER</div>
                    <div class="lobby-subtitle">ACQUIRE CAPITAL</div>
                </div>

                <!-- COIN PACKAGES -->
                <div class="coin-grid">
                    <div class="coin-tile" onclick="window.buyRealCoins(1000)"><div class="coin-amount">1,000</div><div class="coin-price">‚Ç¨10.00</div></div>
                    <div class="coin-tile" onclick="window.buyRealCoins(5500)"><div class="coin-amount">5,500</div><div class="coin-price">‚Ç¨50.00</div></div>
                    <div class="coin-tile" onclick="window.buyRealCoins(12000)"><div class="coin-amount">12,000</div><div class="coin-price">‚Ç¨100.00</div></div>
                    <div class="coin-tile" onclick="window.buyRealCoins(30000)"><div class="coin-amount">30,000</div><div class="coin-price">‚Ç¨250.00</div></div>
                    <div class="coin-tile" onclick="window.buyRealCoins(70000)"><div class="coin-amount">70,000</div><div class="coin-price">‚Ç¨500.00</div></div>
                    <div class="coin-tile" onclick="window.buyRealCoins(150000)"><div class="coin-amount">150,000</div><div class="coin-price">‚Ç¨1000.00</div></div>
                </div>
                <button class="lobby-btn close" onclick="closeExchequer()" style="margin-top:20px;">CLOSE</button>
            </div>
        </div>
        <div style="height: 120px;"></div>
    </div>
      
    <!-- POVERTY OVERLAY -->
    <div id="povertyOverlay" class="mob-reward-overlay hidden">
        <div class="mob-reward-card" style="border-color: #ff003c; box-shadow: 0 0 30px rgba(255, 0, 60, 0.2);">
            <div class="mob-hex-wrap small-reward" style="background: linear-gradient(135deg, #ff003c, #000);">
                <div class="mob-rank-stamp" style="right: auto; left: -5px; color: #fff; border-color: #fff;">DENIED</div>
            </div>
            <h2 class="mob-reward-title" style="color:#ff003c;">INSUFFICIENT CAPITAL</h2>
            <div id="povertyInsult" style="font-family:'Cinzel'; color:#ccc; font-size:0.85rem; line-height:1.4; padding:0 10px;">
                You cannot afford my attention.
            </div>
            <div class="mob-reward-actions" style="margin-top:10px;">
                <button onclick="goToExchequer()" class="mob-action-btn" style="border-color: #ff003c; color: #ff003c;">BOOST WALLET</button>
                <button onclick="closePoverty()" class="mob-action-btn" style="border-color: #444; color: #888;">APOLOGIZE & RETURN</button>
            </div>
        </div>
    </div>

</div> <!-- THIS IS THE CLOSING DIV FOR #MOBILE_APP -->
<script>
    function checkDevice() {
        const isMobile = window.innerWidth <= 768;
        const desktop = document.getElementById('DESKTOP_APP');
        const mobile = document.getElementById('MOBILE_APP');
        const dashboard = document.getElementById('viewMobileHome');
        
        if (isMobile) {
            if(desktop) desktop.style.display = 'none';
            if(mobile) mobile.style.display = 'flex';
            // Force Dashboard Visible
            if(dashboard) {
                dashboard.style.display = 'flex';
                dashboard.style.visibility = 'visible';
                dashboard.style.opacity = '1';
            }
        } else {
            if(mobile) mobile.style.display = 'none';
            if(desktop) desktop.style.display = 'flex'; 
        }
    }
    // Run immediately and on resize
    checkDevice();
    window.addEventListener('resize', checkDevice);
    window.addEventListener('load', checkDevice);
</script>
</body>
</html>
